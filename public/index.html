<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестовая система ПАО "РОССЕТИ ЮГ"</title>
    
    <!-- Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">

    <!-- Подключение SheetJS для Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    
    <!-- Подключение CryptoJS для шифрования -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Подключение html-docx-js для офлайн экспорта в Word -->
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
     
    <style>
        /* Улучшенные стили с визуальными улучшениями */
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #eef2ff 100%);
            color: #333;
            line-height: 1.6;
            user-select: none;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a3a8f 0%, #2d5cc2 100%);
            color: white;
            padding: 35px 0;
            text-align: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 35px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffcc00, #ff9800, #ff5722);
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .timer-container {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .timer {
            font-size: 1.6rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .timer.warning {
            color: #ffcc00;
            animation: pulse 1.5s infinite;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        .timer.danger {
            color: #ff3333;
            animation: pulse 1s infinite;
            text-shadow: 0 0 10px rgba(255, 51, 51, 0.5);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        header h1 {
            margin: 0;
            font-size: 2.7rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }
        
        header p {
            margin: 12px 0 0;
            font-size: 1.25rem;
            opacity: 0.95;
            font-weight: 300;
        }
        
        /* Стили для индикатора времени на вопрос */
        .question-time-indicator {
            margin-top: 12px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .question-time-indicator.green {
            background-color: rgba(46, 204, 113, 0.15);
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        
        .question-time-indicator.yellow {
            background-color: rgba(241, 196, 15, 0.15);
            color: #f39c12;
            border: 2px solid #f39c12;
        }
        
        .question-time-indicator.red {
            background-color: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            border: 2px solid #e74c3c;
            animation: blinkRed 1s infinite;
        }
        
        @keyframes blinkRed {
            0% { border-color: #e74c3c; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            50% { border-color: #ff6b6b; box-shadow: 0 0 10px rgba(255, 107, 107, 0.7); }
            100% { border-color: #e74c3c; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
        }
        
        .question-time-warning {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            color: #856404;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 12px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Стили для мигания вопроса при долгом ответе */
        .question-warning-pulse {
            animation: questionWarningPulse 1s infinite;
        }
        
        @keyframes questionWarningPulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .user-info-form {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .user-info-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .user-info-form h3 {
            color: #1a3a8f;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .test-settings-form {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
            display: none;
        }
        
        .test-settings-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .test-settings-form h3 {
            color: #1a3a8f;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group label i {
            color: #2d5cc2;
            font-size: 0.9rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e6e9f0;
            border-radius: 10px;
            font-size: 1.05rem;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2d5cc2;
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 92, 194, 0.1);
            transform: translateY(-2px);
        }
        
        .form-group input:valid {
            border-color: #27ae60;
        }
        
        .form-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .time-slider-container {
            flex: 1;
            min-width: 200px;
        }
        
        .time-slider {
            width: 100%;
            height: 12px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(90deg, #e6e9f0, #d0d7f0);
            border-radius: 10px;
            outline: none;
            margin: 10px 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            cursor: pointer;
            border: 4px solid white;
            box-shadow: 0 3px 15px rgba(45, 92, 194, 0.4);
            transition: all 0.3s ease;
        }
        
        .time-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 20px rgba(45, 92, 194, 0.6);
        }
        
        .time-slider::-webkit-slider-runnable-track {
            height: 12px;
            border-radius: 10px;
            background: linear-gradient(90deg, #e6e9f0, #d0d7f0);
        }
        
        .time-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            cursor: pointer;
            border: 4px solid white;
            box-shadow: 0 3px 15px rgba(45, 92, 194, 0.4);
            transition: all 0.3s ease;
        }
        
        .time-slider::-moz-range-track {
            height: 12px;
            border-radius: 10px;
            background: linear-gradient(90deg, #e6e9f0, #d0d7f0);
        }
        
        .time-input {
            width: 100px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 12px;
            border: 2px solid #2d5cc2;
            border-radius: 10px;
            background: white;
            color: #1a3a8f;
            box-shadow: 0 3px 10px rgba(45, 92, 194, 0.1);
        }
        
        .time-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(45, 92, 194, 0.2);
        }
        
        .time-display {
            font-size: 1.15rem;
            font-weight: 600;
            color: #2d5cc2;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f0f4ff, #e6e9f0);
            border-radius: 10px;
            border: 2px solid #e6e9f0;
        }
        
        .time-display i {
            color: #ff9800;
            font-size: 1.2rem;
        }
        
        .shuffle-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px solid #e6e9f0;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .shuffle-control:hover {
            border-color: #2d5cc2;
            background: #eef2ff;
            transform: translateY(-2px);
        }
        
        .shuffle-label {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shuffle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .shuffle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .shuffle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e6e9f0;
            transition: .4s;
            border-radius: 34px;
        }
        
        .shuffle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .shuffle-slider {
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
        }
        
        input:checked + .shuffle-slider:before {
            transform: translateX(30px);
        }
        
        .shuffle-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            padding-left: 5px;
        }
        
        .settings-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
            padding-left: 5px;
        }
        
        .test-info {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 35px;
            display: none;
            justify-content: space-around;
            flex-wrap: wrap;
            border: 1px solid #eef2ff;
        }
        
        .info-item {
            text-align: center;
            padding: 20px;
            min-width: 220px;
            transition: transform 0.3s ease;
        }
        
        .info-item:hover {
            transform: translateY(-5px);
        }
        
        .info-item i {
            font-size: 2.5rem;
            color: #2d5cc2;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .info-item h3 {
            margin: 10px 0;
            color: #1a3a8f;
            font-size: 1.3rem;
        }
        
        .info-item p {
            color: #666;
            font-size: 1rem;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e6e9f0;
            border-radius: 12px;
            margin: 25px 0;
            height: 14px;
            overflow: hidden;
            display: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2d5cc2 0%, #1a3a8f 100%);
            border-radius: 12px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg, 
                rgba(255, 255, 255, 0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.2) 75%, 
                transparent 75%, 
                transparent
            );
            background-size: 30px 30px;
            animation: moveStripes 1s linear infinite;
        }
        
        @keyframes moveStripes {
            0% { background-position: 0 0; }
            100% { background-position: 30px 0; }
        }
        
        .single-question-container {
            display: none;
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            position: relative;
            border: 1px solid #eef2ff;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .single-question-container.warning-pulse {
            animation: questionWarningPulse 1s infinite;
        }
        
        .single-question-container:hover {
            transform: translateY(-5px);
        }
        
        .question-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 2px solid #eef2ff;
        }
        
        .question-number-large {
            font-size: 2.8rem;
            font-weight: 800;
            color: #2d5cc2;
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .question-progress-text {
            font-size: 1.25rem;
            color: #666;
            font-weight: 500;
        }
        
        .question-progress-bar {
            flex: 1;
            height: 10px;
            background-color: #e6e9f0;
            border-radius: 5px;
            margin: 0 25px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .question-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5cc2 0%, #1a3a8f 100%);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .section-indicator {
            display: inline-block;
            padding: 10px 25px;
            background: linear-gradient(135deg, #eef2ff, #e6e9f0);
            color: #2d5cc2;
            border-radius: 25px;
            font-weight: 700;
            margin-bottom: 25px;
            font-size: 1rem;
            border: 2px solid #e6e9f0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .single-question-text {
            font-size: 1.35rem;
            font-weight: 600;
            margin-bottom: 40px;
            color: #222;
            line-height: 1.9;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #2d5cc2;
        }
        
        .single-options {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 45px;
        }
        
        .single-option {
            padding: 22px;
            border: 2px solid #e6e9f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            background: white;
        }
        
        .single-option:hover:not(.locked) {
            background-color: #f8f9ff;
            border-color: #b8c5ff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .single-option.selected {
            background-color: #eef2ff;
            border-color: #2d5cc2;
            box-shadow: 0 5px 20px rgba(45, 92, 194, 0.15);
            transform: translateY(-3px);
        }
        
        .single-option.correct {
            background-color: #e7f7ef;
            border-color: #2ecc71;
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.15);
        }
        
        .single-option.incorrect {
            background-color: #fdeaea;
            border-color: #e74c3c;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.1);
        }
        
        .single-option.locked {
            cursor: not-allowed;
            opacity: 0.9;
        }
        
        .single-option.locked:hover {
            transform: none;
            box-shadow: none;
            background-color: white;
        }
        
        .single-option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            background-color: #e6e9f0;
            border-radius: 50%;
            text-align: center;
            margin-right: 25px;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .selected .single-option-letter {
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            color: white;
            box-shadow: 0 3px 10px rgba(45, 92, 194, 0.3);
        }
        
        .correct .single-option-letter {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }
        
        .incorrect .single-option-letter {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }
        
        .single-option-text {
            font-size: 1.15rem;
            flex: 1;
        }
        
        .single-question-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 35px;
            border-top: 2px solid #eef2ff;
        }
        
        .single-question-navigation {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }
        
        .question-bookmark {
            position: absolute;
            top: 25px;
            right: 25px;
            color: #ffc107;
            font-size: 1.8rem;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));
        }
        
        .question-bookmark:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        .question-bookmark.active {
            opacity: 1;
            color: #ff9800;
            filter: drop-shadow(0 3px 8px rgba(255, 152, 0, 0.4));
        }
        
        .section-title {
            color: #1a3a8f;
            border-bottom: 3px solid #eef2ff;
            padding-bottom: 18px;
            margin-bottom: 30px;
            font-size: 1.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 14px 35px;
            border: none;
            border-radius: 10px;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            color: white;
            box-shadow: 0 4px 15px rgba(45, 92, 194, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1a3a8f, #2d5cc2);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(45, 92, 194, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #219653, #27ae60);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #138496, #17a2b8);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800, #ffc107);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }
        
        .btn-excel {
            background: linear-gradient(135deg, #217346, #1b5e3c);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 115, 70, 0.3);
        }
        
        .btn-excel:hover {
            background: linear-gradient(135deg, #1b5e3c, #217346);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(33, 115, 70, 0.4);
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-pdf:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-word {
            background: linear-gradient(135deg, #2b579a, #1e3a6f);
            color: white;
            box-shadow: 0 4px 15px rgba(43, 87, 154, 0.3);
        }
        
        .btn-word:hover {
            background: linear-gradient(135deg, #1e3a6f, #2b579a);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(43, 87, 154, 0.4);
        }
        
        .result-panel {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            text-align: center;
            display: none;
            margin-bottom: 35px;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .result-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .result-panel h2 {
            color: #1a3a8f;
            margin-bottom: 25px;
            font-size: 2.2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .result-user-info {
            font-size: 1.25rem;
            color: #555;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 2px solid #eef2ff;
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        
        .score-circle {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            margin: 0 auto 35px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: conic-gradient(#27ae60 0% 0%, #e6e9f0 0% 100%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 8px solid white;
        }
        
        .score-circle::before {
            content: '';
            position: absolute;
            width: 180px;
            height: 180px;
            background-color: white;
            border-radius: 50%;
            box-shadow: inset 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .score {
            font-size: 3.2rem;
            font-weight: 800;
            color: #1a3a8f;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .results-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 45px 0;
            gap: 20px;
        }
        
        .result-item {
            padding: 30px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            text-align: center;
            min-width: 220px;
            margin: 10px;
            flex: 1;
            border: 2px solid #eef2ff;
            transition: transform 0.3s ease;
        }
        
        .result-item:hover {
            transform: translateY(-5px);
        }
        
        .result-value {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .result-value.correct {
            color: #27ae60;
        }
        
        .result-value.incorrect {
            color: #e74c3c;
        }
        
        .review-section {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            display: none;
            border: 1px solid #eef2ff;
        }
        
        .review-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 35px;
            padding-top: 25px;
            border-top: 2px solid #eef2ff;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .review-navigation {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 25px 0;
        }
        
        .review-question-counter {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.3rem;
            color: #1a3a8f;
            font-weight: bold;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #2d5cc2;
        }
        
        .correct-answer-hint {
            background-color: #e7f7ef;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 18px;
            margin-top: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .unanswered-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .unanswered-form {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 650px;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .unanswered-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        .unanswered-form h3 {
            color: #e74c3c;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.8rem;
        }
        
        .unanswered-list {
            max-height: 350px;
            overflow-y: auto;
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #fdeaea;
            border-radius: 10px;
            background-color: #fffafa;
        }
        
        .unanswered-item {
            padding: 15px 20px;
            margin-bottom: 12px;
            background-color: white;
            border-left: 5px solid #e74c3c;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .unanswered-item:hover {
            background-color: #fdeaea;
            transform: translateX(8px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .unanswered-item-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 50%;
            text-align: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
        }
        
        .unanswered-actions {
            display: flex;
            gap: 18px;
            margin-top: 35px;
            justify-content: center;
        }
        
        .unanswered-actions .btn {
            flex: 1;
            justify-content: center;
        }
        
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .password-form {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 550px;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .password-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .password-form h3 {
            color: #1a3a8f;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.8rem;
        }
        
        .password-actions {
            display: flex;
            gap: 18px;
            margin-top: 35px;
            justify-content: center;
        }
        
        .password-actions .btn {
            flex: 1;
            justify-content: center;
        }
        
        .password-error {
            color: #e74c3c;
            font-size: 1rem;
            margin-top: 15px;
            text-align: center;
            display: none;
            padding: 12px;
            background: #fdeaea;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            color: #666;
            font-size: 0.95rem;
            border-top: 2px solid #e6e9f0;
            margin-top: 35px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }
        
        .jump-to-question {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 100;
        }
        
        .jump-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            color: white;
            border: none;
            font-size: 1.7rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .jump-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .jump-btn:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .jump-btn:hover::before {
            opacity: 1;
        }
        
        .jump-dropdown {
            position: absolute;
            bottom: 75px;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 320px;
            max-height: 450px;
            overflow-y: auto;
            display: none;
            padding: 20px;
            border: 1px solid #eef2ff;
        }
        
        .jump-dropdown.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .jump-title {
            color: #1a3a8f;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eef2ff;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .jump-section {
            margin-bottom: 20px;
        }
        
        .jump-section-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 12px;
            font-weight: 600;
            padding-left: 5px;
        }
        
        .jump-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .jump-question-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #e6e9f0;
            background: white;
            color: #333;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .jump-question-btn:hover {
            border-color: #2d5cc2;
            background-color: #eef2ff;
            transform: scale(1.1);
        }
        
        .jump-question-btn.answered {
            background: linear-gradient(135deg, #e7f7ef, #d4edda);
            border-color: #27ae60;
            color: #219653;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.2);
        }
        
        .jump-question-btn.current {
            background: linear-gradient(135deg, #ff9800, #e68900);
            border-color: #e68900;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            transform: scale(1.1);
            animation: pulse-current 2s infinite;
        }
        
        @keyframes pulse-current {
            0% { box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(255, 152, 0, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); }
        }
        
        .jump-question-btn.skipped {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #ffc107;
            color: #e0a800;
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.2);
        }
        
        .bookmarked-questions {
            position: fixed;
            bottom: 40px;
            left: 40px;
            z-index: 100;
        }
        
        .bookmarks-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800, #e68900);
            color: white;
            border: none;
            font-size: 1.7rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .bookmarks-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .bookmarks-btn:hover {
            transform: scale(1.15) rotate(-5deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .bookmarks-btn:hover::before {
            opacity: 1;
        }
        
        .bookmarks-dropdown {
            position: absolute;
            bottom: 75px;
            left: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 320px;
            max-height: 450px;
            overflow-y: auto;
            display: none;
            padding: 20px;
            border: 1px solid #eef2ff;
        }
        
        .bookmarks-dropdown.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        .bookmarks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .no-bookmarks {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 30px;
            font-size: 1.1rem;
        }
        
        .detailed-results {
            background-color: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            display: none;
            border: 1px solid #eef2ff;
        }
        
        .detailed-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #eef2ff;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .detailed-results-title {
            color: #1a3a8f;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .result-item-details {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #e6e9f0;
            transition: transform 0.3s ease;
        }
        
        .result-item-details:hover {
            transform: translateY(-3px);
        }
        
        .result-item-details.correct {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #e7f7ef, #d4edda);
        }
        
        .result-item-details.incorrect {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fdeaea, #f8d7da);
        }
        
        .result-item-details.skipped {
            border-left-color: #ff9800;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        }
        
        .result-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .result-item-number {
            font-weight: bold;
            color: #1a3a8f;
            font-size: 1.2rem;
        }
        
        .result-item-status {
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .status-correct {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
        }
        
        .status-incorrect {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .status-skipped {
            background: linear-gradient(135deg, #ff9800, #e68900);
            color: white;
        }
        
        .result-item-question {
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.15rem;
            line-height: 1.7;
        }
        
        .result-item-answer {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .answer-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 1rem;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .answer-letter.user {
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            color: white;
        }
        
        .answer-letter.correct {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
        }
        
        .answer-letter.incorrect {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .answer-text {
            flex: 1;
        }
        
        .toggle-details-btn {
            background: none;
            border: none;
            color: #2d5cc2;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .toggle-details-btn:hover {
            background-color: #eef2ff;
            transform: translateX(5px);
        }
        
        @media (max-width: 768px) {
            .test-info {
                flex-direction: column;
            }
            
            .single-question-controls {
                flex-direction: column;
                gap: 18px;
            }
            
            .single-question-navigation {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }
            
            .single-question-navigation .btn {
                flex: 1;
                min-width: 150px;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .results-details {
                flex-direction: column;
                align-items: center;
            }
            
            .unanswered-actions {
                flex-direction: column;
            }
            
            .password-actions {
                flex-direction: column;
            }
            
            .jump-to-question {
                bottom: 25px;
                right: 25px;
            }
            
            .bookmarked-questions {
                bottom: 25px;
                left: 25px;
            }
            
            .jump-dropdown,
            .bookmarks-dropdown {
                width: 300px;
                max-height: 350px;
            }
            
            .detailed-results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            header p {
                font-size: 1.1rem;
            }
            
            .user-info-form {
                padding: 30px 25px;
            }
            
            .test-settings-form {
                padding: 30px 25px;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 1.05rem;
            }
        }
        
        /* Улучшенная адаптивность для мобильных устройств */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            header {
                padding: 25px 0;
            }
            
            header h1 {
                font-size: 1.6rem;
            }
            
            header p {
                font-size: 1rem;
            }
            
            .user-info-form {
                padding: 25px 20px;
            }
            
            .test-settings-form {
                padding: 25px 20px;
            }
            
            .user-info-form h3 {
                font-size: 1.6rem;
            }
            
            .single-question-container {
                padding: 25px 20px;
            }
            
            .single-question-text {
                font-size: 1.15rem;
            }
            
            .single-option {
                padding: 18px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .single-option-letter {
                width: 40px;
                height: 40px;
                margin-right: 0;
            }
            
            .question-number-large {
                font-size: 2.2rem;
            }
            
            .question-progress {
                flex-direction: column;
                gap: 18px;
                align-items: flex-start;
            }
            
            .question-progress-bar {
                width: 100%;
                margin: 12px 0;
            }
            
            .section-indicator {
                font-size: 0.9rem;
                padding: 8px 20px;
            }
            
            .jump-btn, .bookmarks-btn {
                width: 55px;
                height: 55px;
                font-size: 1.4rem;
                bottom: 20px;
                right: 20px;
            }
            
            .bookmarked-questions {
                bottom: 20px;
                left: 20px;
            }
            
            .jump-dropdown, .bookmarks-dropdown {
                width: 280px;
                max-height: 350px;
                right: -30px;
                bottom: 65px;
            }
            
            .bookmarks-dropdown {
                left: -30px;
                right: auto;
            }
            
            .result-item {
                min-width: 150px;
                padding: 20px;
            }
            
            .result-value {
                font-size: 2.2rem;
            }
            
            .score-circle {
                width: 200px;
                height: 200px;
            }
            
            .score-circle::before {
                width: 160px;
                height: 160px;
            }
            
            .score {
                font-size: 2.8rem;
            }
            
            .review-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .review-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .result-panel {
                padding: 30px 20px;
            }
            
            .detailed-results {
                padding: 25px 20px;
            }
            
            .export-progress-content {
                padding: 30px 20px;
            }
        }
        
        @media (max-width: 360px) {
            .container {
                padding: 12px;
            }
            
            .user-info-form {
                padding: 22px 18px;
            }
            
            .test-settings-form {
                padding: 22px 18px;
            }
            
            .single-question-container {
                padding: 22px 18px;
            }
            
            .jump-btn, .bookmarks-btn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
            
            .jump-question-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .result-item {
                min-width: 130px;
                padding: 15px;
            }
            
            .result-value {
                font-size: 2rem;
            }
        }
        
        .password-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            display: block;
            padding-left: 5px;
        }
        
        .all-questions-container {
            display: none;
        }
        
        .skipped-questions-container {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            border: 1px solid #eef2ff;
        }
        
        .skipped-question-item {
            padding: 18px;
            margin-bottom: 18px;
            background-color: white;
            border-radius: 10px;
            border-left: 5px solid #ff9800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .skipped-question-item:hover {
            background-color: #fff3cd;
            transform: translateX(8px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .skipped-actions {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 45px;
            padding-top: 25px;
            border-top: 2px solid #e6e9f0;
            flex-wrap: wrap;
        }
        
        .skipped-question-number {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #ff9800, #e68900);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            margin-right: 18px;
            font-weight: bold;
            box-shadow: 0 3px 8px rgba(255, 152, 0, 0.3);
            flex-shrink: 0;
        }
        
        .export-progress {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .export-progress-content {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 1px solid #eef2ff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .export-progress-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .export-progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e6e9f0;
            border-radius: 6px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .export-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5cc2 0%, #1a3a8f 100%);
            border-radius: 6px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .json-upload-container {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .json-upload-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .json-upload-container h3 {
            color: #1a3a8f;
            margin-bottom: 30px;
            font-size: 1.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .upload-area {
            border: 3px dashed #e6e9f0;
            border-radius: 15px;
            padding: 50px 25px;
            margin: 25px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            border-color: #2d5cc2;
            background-color: #eef2ff;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background-color: #e7f7ef;
            transform: scale(1.02);
        }
        
        .upload-area i {
            font-size: 4.5rem;
            background: linear-gradient(135deg, #2d5cc2, #1a3a8f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            display: block;
        }
        
        .upload-info {
            color: #666;
            font-size: 1rem;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .upload-success {
            color: #27ae60;
            font-weight: 700;
            margin-top: 20px;
            display: none;
            padding: 15px;
            background: #e7f7ef;
            border-radius: 10px;
            border-left: 4px solid #27ae60;
        }
        
        .upload-error {
            color: #e74c3c;
            font-weight: 700;
            margin-top: 20px;
            display: none;
            padding: 15px;
            background: #fdeaea;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }
        
        .uploaded-file-info {
            background: linear-gradient(135deg, #f8f9ff, #eef2ff);
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
            text-align: left;
            display: none;
            border: 2px solid #e6e9f0;
        }
        
        /* Новые стили для улучшенной статистики */
        .extended-stats {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #eef2ff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #eef2ff;
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #1a3a8f;
            margin-bottom: 8px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 1rem;
            color: #666;
        }
        
        .section-stats {
            margin-top: 25px;
            border-top: 3px solid #eef2ff;
            padding-top: 25px;
        }
        
        .section-stat-item {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f0f4ff, #e6e9f0);
            border-radius: 10px;
            border: 1px solid #e6e9f0;
        }
        
        .section-stat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .section-stat-name {
            font-weight: bold;
            color: #1a3a8f;
            font-size: 1.1rem;
        }
        
        .section-stat-percentage {
            font-weight: bold;
            color: #2d5cc2;
        }
        
        .section-stat-bar {
            height: 10px;
            background-color: #e6e9f0;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .section-stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5cc2 0%, #1a3a8f 100%);
            border-radius: 5px;
            transition: width 1s ease;
        }
        
        /* Стили для настройки пароля */
        .password-settings {
            background-color: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            margin-bottom: 35px;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
            display: none;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .password-settings::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .password-settings h3 {
            color: #1a3a8f;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .password-settings .btn {
            width: 100%;
            margin-top: 25px;
        }
        
        /* Стили для офлайн режима */
        .offline-notification {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 9999;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        /* Стили для восстановления теста */
        .restore-test-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .restore-test-form {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 550px;
            text-align: center;
            border: 1px solid #eef2ff;
            position: relative;
            overflow: hidden;
        }
        
        .restore-test-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .restore-test-form h3 {
            color: #2d5cc2;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .restore-actions {
            display: flex;
            gap: 18px;
            margin-top: 35px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Стили для сложности вопросов */
        .difficulty-indicator {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-left: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .difficulty-easy {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
        }
        
        .difficulty-medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .difficulty-hard {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        /* Стили для паузы теста */
        .pause-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .pause-message {
            background-color: white;
            padding: 45px;
            border-radius: 15px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 1px solid #eef2ff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .pause-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2d5cc2, #1a3a8f);
        }
        
        .pause-message h2 {
            color: #2d5cc2;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        /* Стили для прогресса загрузки вопросов */
        .loading-questions {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #2d5cc2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Новый стиль для отображения времени на вопрос */
        .question-time-info {
            margin-top: 12px;
            font-size: 0.9rem;
            color: #666;
            padding: 10px 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            display: inline-block;
            border: 1px solid #e6e9f0;
        }
        
        .question-time-info i {
            margin-right: 8px;
            color: #2d5cc2;
        }
        
        /* Улучшенные стили для кнопок экспорта */
        .export-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .export-btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Дополнительные улучшения для визуального восприятия */
        .glow-effect {
            position: relative;
        }
        
        .glow-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            box-shadow: 0 0 20px rgba(45, 92, 194, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .glow-effect:hover::after {
            opacity: 1;
        }
        
        /* Анимация появления элементов */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Улучшенные тени и градиенты */
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            transition: box-shadow 0.3s ease;
        }
        
        .card-shadow:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.18);
        }
        
        /* Стили для выделения активных элементов */
        .active-element {
            position: relative;
            z-index: 1;
        }
        
        .active-element::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #2d5cc2, #1a3a8f, #2d5cc2);
            border-radius: inherit;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .active-element.active::before {
            opacity: 1;
        }
        
        /* Стили для офлайн экспорта в Word */
        .offline-word-export {
            background: linear-gradient(135deg, #2b579a, #1e3a6f);
            color: white;
            box-shadow: 0 4px 15px rgba(43, 87, 154, 0.3);
        }
        
        .offline-word-export:hover {
            background: linear-gradient(135deg, #1e3a6f, #2b579a);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(43, 87, 154, 0.4);
        }
        
        /* Стили для отображения результата после ответа */
        .answer-feedback {
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 1.15rem;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .answer-feedback.correct {
            background: linear-gradient(135deg, #e7f7ef, #d4edda);
            border: 2px solid #27ae60;
            color: #155724;
        }
        
        .answer-feedback.incorrect {
            background: linear-gradient(135deg, #fdeaea, #f8d7da);
            border: 2px solid #e74c3c;
            color: #721c24;
        }
        
        .correct-answer-indicator {
            margin-top: 15px;
            padding: 12px;
            background-color: #e7f7ef;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            font-weight: 600;
        }
        
        .show-correct-answer {
            animation: highlightCorrect 0.8s ease;
        }
        
        @keyframes highlightCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(46, 204, 113, 0.4); }
            100% { transform: scale(1); }
        }
        
        .highlight-incorrect {
            animation: highlightIncorrect 0.8s ease;
        }
        
        @keyframes highlightIncorrect {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }
            100% { transform: scale(1); }
        }

        /* Стили для режима тренировки */
        .training-mode-indicator {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 1rem;
            border: 2px solid #2980b9;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .training-mode-hint {
            background-color: #e8f4fc;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 1rem;
            color: #2c3e50;
            line-height: 1.5;
        }

        .training-mode-hint i {
            color: #3498db;
            margin-right: 10px;
        }

        .training-mode-option {
            transition: all 0.3s ease;
        }

        .training-mode-option.correct {
            background-color: #e7f7ef;
            border-color: #27ae60;
        }

        .training-mode-option.incorrect {
            background-color: #fdeaea;
            border-color: #e74c3c;
        }

        .training-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eef2ff;
        }
    </style>
</head>
<body>
    
    <div class="unanswered-modal" id="unanswered-modal">
        <div class="unanswered-form">
            <h3><i class="fas fa-exclamation-triangle"></i> Неотвеченные вопросы</h3>
            <p>Вы не ответили на следующие вопросы. Что вы хотите сделать?</p>
            
            <div class="unanswered-list" id="unanswered-list">
            </div>
            
            <div class="unanswered-actions">
                <button class="btn btn-primary" id="answer-unanswered-btn">
                    <i class="fas fa-edit"></i> Ответить на вопросы
                </button>
                <button class="btn btn-warning" id="skip-unanswered-btn">
                    <i class="fas fa-forward"></i> Пропустить вопросы (будут засчитаны как неправильные)
                </button>
            </div>
        </div>
    </div>
    
    <div class="password-modal" id="password-modal">
        <div class="password-form">
            <h3><i class="fas fa-lock"></i> Введите пароль</h3>
            <p>Для запуска нового теста необходимо ввести пароль.</p>
            
            <div class="form-group">
                <input type="password" id="password-input" placeholder="Введите пароль" autocomplete="off">
            </div>
            
            <div class="password-error" id="password-error">
                Неверный пароль. Попробуйте еще раз.
            </div>
            
            <div class="password-actions">
                <button class="btn btn-primary" id="confirm-password-btn">
                    <i class="fas fa-check"></i> Подтвердить
                </button>
                <button class="btn btn-danger" id="cancel-password-btn">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>
    
    <div class="restore-test-modal" id="restore-test-modal">
        <div class="restore-test-form">
            <h3><i class="fas fa-history"></i> Восстановить тест</h3>
            <p>Обнаружен незавершенный тест. Хотите восстановить его?</p>
            
            <div class="restore-info" id="restore-info">
                <!-- Информация о сохраненном тесте -->
            </div>
            
            <div class="restore-actions">
                <button class="btn btn-success" id="restore-test-btn">
                    <i class="fas fa-redo"></i> Восстановить тест
                </button>
                <button class="btn btn-danger" id="discard-test-btn">
                    <i class="fas fa-trash"></i> Начать новый тест
                </button>
            </div>
        </div>
    </div>
    
    <div class="password-settings" id="password-settings">
        <h3><i class="fas fa-cogs"></i> Настройка паролей</h3>
        <div class="form-group">
            <label for="new-admin-password"><i class="fas fa-key"></i> Новый пароль администратора</label>
            <input type="password" id="new-admin-password" placeholder="Введите новый пароль">
        </div>
        <div class="form-group">
            <label for="confirm-admin-password"><i class="fas fa-check-double"></i> Подтвердите пароль</label>
            <input type="password" id="confirm-admin-password" placeholder="Подтвердите новый пароль">
        </div>
        <div class="form-group">
            <label for="new-start-password"><i class="fas fa-key"></i> Новый пароль для запуска теста</label>
            <input type="password" id="new-start-password" placeholder="Введите новый пароль">
        </div>
        <div class="form-group">
            <label for="confirm-start-password"><i class="fas fa-check-double"></i> Подтвердите пароль</label>
            <input type="password" id="confirm-start-password" placeholder="Подтвердите новый пароль">
        </div>
        <button class="btn btn-primary" id="save-passwords-btn">
            <i class="fas fa-save"></i> Сохранить пароли
        </button>
        <button class="btn btn-warning" id="cancel-passwords-btn">
            <i class="fas fa-times"></i> Отмена
        </button>
    </div>
    
    <div class="export-progress" id="export-progress">
        <div class="export-progress-content">
            <h3><i class="fas fa-file-export"></i> Экспорт данных</h3>
            <div class="export-status" id="export-status">Подготовка данных...</div>
            <div class="export-progress-bar">
                <div class="export-progress-fill" id="export-progress-fill"></div>
            </div>
            <div id="export-message">Пожалуйста, подождите...</div>
        </div>
    </div>
    
    <div class="loading-questions" id="loading-questions">
        <div class="loading-spinner"></div>
        <h3>Загрузка вопросов...</h3>
        <p id="loading-progress">0%</p>
    </div>
    
    <div class="pause-overlay" id="pause-overlay">
        <div class="pause-message">
            <h2><i class="fas fa-pause"></i> Тест приостановлен</h2>
            <p>Время теста приостановлено, пока вы неактивны.</p>
            <p>Вернитесь на вкладку, чтобы продолжить тест.</p>
            <div class="timer" id="pause-timer" style="font-size: 2.2rem; margin: 25px 0;"></div>
            <button class="btn btn-primary" id="continue-test-btn">
                <i class="fas fa-play"></i> Продолжить тест
            </button>
        </div>
    </div>
    
    <div class="offline-notification" id="offline-notification">
        <i class="fas fa-wifi-slash"></i> Офлайн режим. Экспорт недоступен.
    </div>
    
    <header>
        <div class="container">
            <h1><i class="fas fa-bolt"></i> ПАО "РОССЕТИ ЮГ" <i class="fas fa-bolt"></i></h1>
            <p>Система Тестирования Персонала</p>
            <div style="margin-top: 15px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
                <button class="btn btn-primary" id="go-admin-btn" style="border-radius:25px; padding:12px 22px;">
                    <i class="fas fa-user-shield"></i> Режим администратора
                </button>
            </div>

            <div class="timer-container" id="timer-container" style="display: none;">
                <i class="fas fa-clock"></i>
                <div class="timer" id="timer">60:00</div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="json-upload-container" id="json-upload-container">
            <h3><i class="fas fa-upload"></i> Загрузка вопросов</h3>
            <p>Загрузите файл с вопросами в формате JSON</p>
            
            <div class="upload-area" id="upload-area">
                <i class="fas fa-file-code"></i>
                <h4>Перетащите файл сюда или нажмите для выбора</h4>
                <p>Поддерживается только формат JSON</p>
            </div>
            
            <input type="file" id="json-file-input" accept=".json" style="display: none;">
            
            <div class="upload-success" id="upload-success">
                <i class="fas fa-check-circle"></i> Файл успешно загружен!
            </div>
            
            <div class="upload-error" id="upload-error">
                <i class="fas fa-exclamation-circle"></i> Ошибка загрузки файла
            </div>
            
            <div class="uploaded-file-info" id="uploaded-file-info">
                <strong>Информация о файле:</strong>
                <div id="file-info-content"></div>
            </div>
            
            <div class="upload-info">
                Поддерживаются различные форматы: стандартные JSON, зашифрованные (AES/Base64), формат Россети
            </div>

            <div id="available-tests-container" style="margin-top: 25px; display: none; text-align: left;">
                <h4 style="color: #1a3a8f; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; justify-content: center; text-align: center;">
                    <i class="fas fa-folder-open"></i> Доступные тесты
                </h4>
                <div id="available-tests-list"></div>
            </div>

            
            <button class="btn btn-primary" id="proceed-to-test-btn" style="width: 100%; margin-top: 25px; display: none;">
                <i class="fas fa-play-circle"></i> Перейти к тестированию
            </button>
            
            <button class="btn btn-warning" id="download-example-btn" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-download"></i> Скачать пример файла Россети
            </button>
            
            <button class="btn btn-info" id="password-settings-btn" style="width: 100%; margin-top: 15px; display: none;">
                <i class="fas fa-cogs"></i> Настройка паролей
            </button>
        </div>
        
        <div class="user-info-form" id="user-info-form" style="display: none;">
            <h3><i class="fas fa-user"></i> Введите ваши данные</h3>
            <div class="form-group">
                <label for="user-name"><i class="fas fa-user-circle"></i> Фамилия Имя Отчество *</label>
                <input type="text" id="user-name" placeholder="Иванов Иван Иванович" required>
            </div>
            <div class="form-group">
                <label for="user-position"><i class="fas fa-briefcase"></i> Должность</label>
                <input type="text" id="user-position" placeholder="Инженер">
            </div>
            <div class="form-group">
                <label for="user-department"><i class="fas fa-building"></i> Подразделение</label>
                <input type="text" id="user-department" placeholder="Отдел автоматизации">
            </div>
            
            <!-- Добавляем выбор режима тестирования -->
            <div class="form-group">
                <label for="test-mode"><i class="fas fa-graduation-cap"></i> Режим тестирования</label>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="test-mode" value="exam" checked style="width: auto;">
                        <span>Экзаменационный режим</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="test-mode" value="training" style="width: auto;">
                        <span>Тренировочный режим</span>
                    </label>
                </div>
                <div class="shuffle-info">
                    В тренировочном режиме вы сможете видеть правильные ответы сразу после выбора и переходить к следующему вопросу
                </div>
            </div>
            
            <button class="btn btn-primary" id="configure-test-btn" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-cog"></i> Настроить параметры теста
            </button>
            <button class="btn btn-warning" id="back-to-upload-btn" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-arrow-left"></i> Загрузить другой файл
            </button>
        </div>
        
        <div class="test-settings-form" id="test-settings-form">
            <h3><i class="fas fa-cogs"></i> Настройка параметров теста</h3>
            
            <div class="form-group">
                <label for="time-limit-slider"><i class="fas fa-clock"></i> Временной лимит теста</label>
                <div class="form-controls">
                    <div class="time-slider-container">
                        <input type="range" min="1" max="999" value="60" class="time-slider" id="time-limit-slider">
                    </div>
                    <input type="number" min="1" max="999" value="60" class="time-input" id="time-limit-input">
                    <span style="font-weight: bold; white-space: nowrap;">мин</span>
                </div>
                <div class="time-display">
                    <i class="fas fa-info-circle"></i>
                    <span id="time-display-text">Время теста: 60 минут (1 час)</span>
                </div>
                <div class="shuffle-info">
                    Установите ограничение по времени от 1 до 999 минут
                </div>
            </div>
            
            <div class="shuffle-control">
                <div class="shuffle-label">
                    <i class="fas fa-random"></i>
                    <span>Перемешать вопросы</span>
                </div>
                <label class="shuffle-switch">
                    <input type="checkbox" id="shuffle-questions">
                    <span class="shuffle-slider"></span>
                </label>
            </div>
            <div class="shuffle-info">
                При включении этой опции порядок вопросов будет случайным
            </div>
            
            <div class="form-group">
                <label for="start-password"><i class="fas fa-key"></i> Пароль для запуска теста *</label>
                <input type="password" id="start-password" placeholder="Введите пароль для запуска" required autocomplete="new-password">
                <span class="password-note">Пароль не будет сохранен в браузере</span>
            </div>
            
            <div class="settings-buttons">
                <button class="btn btn-primary" id="save-settings-btn" style="flex: 2;">
                    <i class="fas fa-save"></i> Сохранить настройки и начать тест
                </button>
                <button class="btn btn-warning" id="back-to-user-info-btn" style="flex: 1;">
                    <i class="fas fa-arrow-left"></i> Назад
                </button>
            </div>
        </div>
        
        <div class="test-info" id="test-info">
            <div class="info-item">
                <i class="fas fa-clipboard-list"></i>
                <h3>Вопросы</h3>
                <p id="questions-count">0 вопросов</p>
            </div>
            <div class="info-item">
                <i class="fas fa-clock"></i>
                <h3 id="test-time-limit">60 минут</h3>
                <p>Ограничение по времени</p>
            </div>
            <div class="info-item">
                <i class="fas fa-random"></i>
                <h3 id="shuffle-status">Стандартный порядок</h3>
                <p>Порядок вопросов</p>
            </div>
            <div class="info-item">
                <i class="fas fa-key"></i>
                <h3>Защищено</h3>
                <p>Вопросы зашифрованы</p>
            </div>
        </div>
        
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="all-questions-container" id="all-questions-container">
        </div>
        
        <div id="single-question-display">
        </div>
        
        <div class="jump-to-question" id="jump-to-question" style="display: none;">
            <button class="jump-btn" id="jump-btn">
                <i class="fas fa-list-ol"></i>
            </button>
            <div class="jump-dropdown" id="jump-dropdown">
                <div class="jump-title">Перейти к вопросу</div>
            </div>
        </div>
        
        <div class="bookmarked-questions" id="bookmarked-questions" style="display: none;">
            <button class="bookmarks-btn" id="bookmarks-btn">
                <i class="fas fa-bookmark"></i>
            </button>
            <div class="bookmarks-dropdown" id="bookmarks-dropdown">
                <div class="jump-title">Закладки</div>
                <div class="bookmarks-list" id="bookmarks-list">
                </div>
                <div class="no-bookmarks" id="no-bookmarks" style="display: none;">
                    Нет закладок
                </div>
            </div>
        </div>
        
        <div class="review-section" id="review-section">
            <div class="section-title">
                <i class="fas fa-list-check"></i> Просмотр результатов теста
            </div>
            
            <div class="review-question-counter" id="review-question-counter">
                Вопрос 1 из 0
            </div>
            
            <div id="review-content">
            </div>
            
            <div class="review-navigation">
                <button class="btn btn-primary" id="review-prev">
                    <i class="fas fa-chevron-left"></i> Предыдущий
                </button>
                <button class="btn btn-primary" id="review-next">
                    Следующий <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="review-controls">
                <button class="btn btn-info" id="review-to-results">
                    <i class="fas fa-chart-bar"></i> Вернуться к результатам
                </button>
                <div class="export-btn-group">
                    <button class="btn btn-word offline-word-export" id="export-word-offline-review">
                        <i class="fas fa-file-word"></i> Экспорт в Word (офлайн)
                    </button>
                    <button class="btn btn-excel" id="export-excel-review">
                        <i class="fas fa-file-excel"></i> Экспорт в Excel (xlsx)
                    </button>
                </div>
            </div>
        </div>
        
        <div class="detailed-results" id="detailed-results" style="display: none;">
            <div class="detailed-results-header">
                <div class="detailed-results-title">
                    <i class="fas fa-eye"></i> Детальные результаты по вопросам
                </div>
                <button class="btn btn-primary" id="back-to-summary-btn">
                    <i class="fas fa-arrow-left"></i> Назад к сводке
                </button>
            </div>
            
            <div id="detailed-results-content">
                <!-- Детальные результаты будут добавлены здесь -->
            </div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 2px solid #e6e9f0;">
                <button class="btn btn-primary" id="back-to-summary-bottom-btn">
                    <i class="fas fa-arrow-left"></i> Назад к сводке
                </button>
            </div>
        </div>
        
        <div class="result-panel" id="result-panel">
            <h2><i class="fas fa-chart-bar"></i> Результаты теста</h2>
            <div class="result-user-info" id="result-user-info">
                <div><i class="fas fa-user"></i> <strong><span id="result-user-name"></span></strong></div>
                <div><i class="fas fa-briefcase"></i> <span id="result-user-position"></span></div>
                <div><i class="fas fa-building"></i> <span id="result-user-department"></span></div>
                <div><i class="fas fa-calendar-alt"></i> Дата: <span id="result-test-date"></span></div>
                <div><i class="fas fa-clock"></i> Время: <span id="result-test-time"></span></div>
                <div><i class="fas fa-cog"></i> Настройки теста: <span id="result-test-settings"></span></div>
            </div>
            
            <div class="score-circle" id="score-circle">
                <div class="score" id="final-score">0%</div>
                <div class="score-label">правильных ответов</div>
            </div>
            
            <div class="results-details">
                <div class="result-item">
                    <div class="result-value correct" id="correct-count">0</div>
                    <div class="result-label">Правильных</div>
                </div>
                <div class="result-item">
                    <div class="result-value incorrect" id="incorrect-count">0</div>
                    <div class="result-label">Неправильных</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="total-answered">0/0</div>
                    <div class="result-label">Отвечено</div>
                </div>
                <div class="result-item">
                    <div class="result-value" id="test-time">00:00</div>
                    <div class="result-label">Время прохождения</div>
                </div>
            </div>
            
            <!-- Расширенная статистика -->
            <div class="extended-stats" id="extended-stats" style="display: none;">
                <h3><i class="fas fa-chart-line"></i> Подробная статистика</h3>
                <div class="stats-grid" id="stats-grid">
                    <!-- Статистика будет сгенерирована динамически -->
                </div>
                
                <div class="section-stats" id="section-stats">
                    <!-- Статистика по разделам будет сгенерирована динамически -->
                </div>
            </div>
            
            <div id="result-message" style="margin: 25px 0; font-size: 1.15rem; padding: 20px; background: #f8f9ff; border-radius: 12px; border-left: 4px solid #2d5cc2;"></div>
            
            <div class="export-buttons-container">
                <div class="export-btn-group">
                    <button class="btn btn-info" id="review-test-btn">
                        <i class="fas fa-list-check"></i> Просмотр результатов теста
                    </button>
                    <button class="btn btn-warning" id="toggle-stats-btn">
                        <i class="fas fa-chart-line"></i> Подробная статистика
                    </button>
                    <button class="btn btn-warning" id="view-detailed-results-btn">
                        <i class="fas fa-eye"></i> Детальные результаты
                    </button>
                </div>
                <div class="export-btn-group">
                    <button class="btn btn-word offline-word-export" id="export-word-offline-btn">
                        <i class="fas fa-file-word"></i> Экспорт в Word (офлайн)
                    </button>
                    <button class="btn btn-excel" id="export-excel-btn">
                        <i class="fas fa-file-excel"></i> Экспорт в Excel (xlsx)
                    </button>
                </div>
                <button class="btn btn-primary" id="new-test-btn">
                    <i class="fas fa-redo"></i> Новый тест
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>Тестовая система ПАО "РОССЕТИ ЮГ" &copy; 2026</p>
            <p id="connection-status" style="font-size: 0.85rem; margin-top: 8px;">
                <i class="fas fa-wifi"></i> Онлайн
            </p>
        </div>
    </div>

    <script>
        // Инициализация констант и переменных
        const DEFAULT_TIME_LIMIT = 60 * 60; // 60 минут в секундах по умолчанию
        const DEFAULT_ADMIN_PASSWORD = "test2025";
        const DEFAULT_START_PASSWORD = "test2025";
        const ENCRYPTION_KEY = "U2FsdGVkX1+ypZ6l4K5V7W8Pq3RstUvw";
        
        // Константы для системы предупреждений о времени ответа
        const TIME_WARNING_LEVELS = {
            GREEN: { min: 0, max: 10, color: 'green', message: 'Оптимальное время ответа' },
            YELLOW: { min: 10, max: 25, color: 'yellow', message: 'Время ответа увеличивается' },
            RED: { min: 25, max: 59, color: 'red', message: 'Слишком долгое время ответа!' }
        };
        
        // Инициализация состояния теста
        let testState = {
            userName: '',
            userPosition: '',
            userDepartment: '',
            timeLimit: DEFAULT_TIME_LIMIT,
            timeLeft: DEFAULT_TIME_LIMIT,
            timer: null,
            currentQuestion: 1,
            answers: {},
            answeredLocked: {}, // Новое поле для блокировки ответов
            reviewMode: false,
            currentReviewQuestion: 1,
            skippedQuestions: [],
            bookmarkedQuestions: [],
            skippedQuestionsMode: false,
            currentSkippedIndex: 0,
            skippedQuestionsList: [],
            startTime: null,
            endTime: null,
            testTitle: 'Тестовая система "РОССЕТИ ЮГ"',
            sections: [],
            questions: [],
            originalQuestions: [], // Сохраняем оригинальный порядок вопросов
            questionResults: [],
            sectionStats: {},
            extendedStats: {},
            isPaused: false,
            isOnline: navigator.onLine,
            totalQuestions: 0,
            testId: null,
            // Аналитика времени на вопросы
            questionTimers: {},
            questionStartTime: null,
            // Настройки теста
            shuffleQuestions: false,
            testSettings: {
                timeLimit: 60, // в минутах
                shuffleEnabled: false
            },
            // Таймер для отслеживания времени на текущий вопрос
            questionTimer: null,
            currentQuestionTime: 0,
            // Добавляем флаг для показа результата
            showAnswerFeedback: true,
            // Добавляем таймер для автоматического перехода
            autoTransitionTimer: null,
            // Добавляем режим тестирования
            testMode: 'exam', // 'exam' или 'training'
            // Добавляем историю ответов для тренировочного режима
            trainingHistory: {}
        };
        
        // Инициализация пользовательских паролей
        let userPasswords = {
            admin: DEFAULT_ADMIN_PASSWORD,
            start: DEFAULT_START_PASSWORD
        };
        
        // DOM элементы
        const elements = {
            // Основные контейнеры
            jsonUploadContainer: document.getElementById('json-upload-container'),
            userInfoForm: document.getElementById('user-info-form'),
            testSettingsForm: document.getElementById('test-settings-form'),
            testInfo: document.getElementById('test-info'),
            progressContainer: document.getElementById('progress-container'),
            timerContainer: document.getElementById('timer-container'),
            timer: document.getElementById('timer'),
            progressBar: document.getElementById('progress-bar'),
            questionsCount: document.getElementById('questions-count'),
            testTimeLimit: document.getElementById('test-time-limit'),
            shuffleStatus: document.getElementById('shuffle-status'),
            
            // Загрузка файлов
            uploadArea: document.getElementById('upload-area'),
            jsonFileInput: document.getElementById('json-file-input'),
            uploadSuccess: document.getElementById('upload-success'),
            uploadError: document.getElementById('upload-error'),
            uploadedFileInfo: document.getElementById('uploaded-file-info'),
            fileInfoContent: document.getElementById('file-info-content'),
            proceedToTestBtn: document.getElementById('proceed-to-test-btn'),
            backToUploadBtn: document.getElementById('back-to-upload-btn'),
            downloadExampleBtn: document.getElementById('download-example-btn'),
            
            // Кнопки управления
            configureTestBtn: document.getElementById('configure-test-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            backToUserInfoBtn: document.getElementById('back-to-user-info-btn'),
            newTestBtn: document.getElementById('new-test-btn'),
            exportWordOfflineBtn: document.getElementById('export-word-offline-btn'),
            exportExcelBtn: document.getElementById('export-excel-btn'),
            reviewTestBtn: document.getElementById('review-test-btn'),
            viewDetailedResultsBtn: document.getElementById('view-detailed-results-btn'),
            backToSummaryBtn: document.getElementById('back-to-summary-btn'),
            backToSummaryBottomBtn: document.getElementById('back-to-summary-bottom-btn'),
            toggleStatsBtn: document.getElementById('toggle-stats-btn'),
            exportWordOfflineReview: document.getElementById('export-word-offline-review'),
            
            // Настройки теста
            timeLimitSlider: document.getElementById('time-limit-slider'),
            timeLimitInput: document.getElementById('time-limit-input'),
            timeDisplayText: document.getElementById('time-display-text'),
            shuffleQuestionsCheckbox: document.getElementById('shuffle-questions'),
            startPasswordInput: document.getElementById('start-password'),
            
            // Модальные окна
            unansweredModal: document.getElementById('unanswered-modal'),
            passwordModal: document.getElementById('password-modal'),
            
            // Списки и элементы
            unansweredList: document.getElementById('unanswered-list'),
            answerUnansweredBtn: document.getElementById('answer-unanswered-btn'),
            skipUnansweredBtn: document.getElementById('skip-unanswered-btn'),
            
            // Пароли
            passwordInput: document.getElementById('password-input'),
            confirmPasswordBtn: document.getElementById('confirm-password-btn'),
            cancelPasswordBtn: document.getElementById('cancel-password-btn'),
            passwordError: document.getElementById('password-error'),
            
            // Отображение вопросов
            singleQuestionDisplay: document.getElementById('single-question-display'),
            allQuestionsContainer: document.getElementById('all-questions-container'),
            
            // Навигация
            jumpToQuestion: document.getElementById('jump-to-question'),
            jumpBtn: document.getElementById('jump-btn'),
            jumpDropdown: document.getElementById('jump-dropdown'),
            
            // Закладки
            bookmarkedQuestions: document.getElementById('bookmarked-questions'),
            bookmarksBtn: document.getElementById('bookmarks-btn'),
            bookmarksDropdown: document.getElementById('bookmarks-dropdown'),
            bookmarksList: document.getElementById('bookmarks-list'),
            noBookmarks: document.getElementById('no-bookmarks'),
            
            // Просмотр результатов
            reviewSection: document.getElementById('review-section'),
            reviewContent: document.getElementById('review-content'),
            reviewQuestionCounter: document.getElementById('review-question-counter'),
            reviewPrev: document.getElementById('review-prev'),
            reviewNext: document.getElementById('review-next'),
            reviewToResults: document.getElementById('review-to-results'),
            exportExcelReview: document.getElementById('export-excel-review'),
            
            // Результаты
            resultPanel: document.getElementById('result-panel'),
            resultUserName: document.getElementById('result-user-name'),
            resultUserPosition: document.getElementById('result-user-position'),
            resultUserDepartment: document.getElementById('result-user-department'),
            resultTestDate: document.getElementById('result-test-date'),
            resultTestTime: document.getElementById('result-test-time'),
            resultTestSettings: document.getElementById('result-test-settings'),
            finalScore: document.getElementById('final-score'),
            correctCount: document.getElementById('correct-count'),
            incorrectCount: document.getElementById('incorrect-count'),
            totalAnswered: document.getElementById('total-answered'),
            testTime: document.getElementById('test-time'),
            resultMessage: document.getElementById('result-message'),
            scoreCircle: document.getElementById('score-circle'),
            
            // Детальные результаты
            detailedResults: document.getElementById('detailed-results'),
            detailedResultsContent: document.getElementById('detailed-results-content'),
            
            // Прогресс экспорта
            exportProgress: document.getElementById('export-progress'),
            exportStatus: document.getElementById('export-status'),
            exportProgressFill: document.getElementById('export-progress-fill'),
            exportMessage: document.getElementById('export-message'),
            
            // Статистика
            extendedStats: document.getElementById('extended-stats'),
            statsGrid: document.getElementById('stats-grid'),
            sectionStats: document.getElementById('section-stats'),
            
            // Загрузка
            loadingQuestions: document.getElementById('loading-questions'),
            loadingProgress: document.getElementById('loading-progress'),
            
            // Пауза
            pauseOverlay: document.getElementById('pause-overlay'),
            pauseTimer: document.getElementById('pause-timer'),
            continueTestBtn: document.getElementById('continue-test-btn'),
            
            // Уведомления
            offlineNotification: document.getElementById('offline-notification'),
            connectionStatus: document.getElementById('connection-status')
        ,
            // Каталог тестов
            availableTestsContainer: document.getElementById('available-tests-container'),
            availableTestsList: document.getElementById('available-tests-list')
};
        
        // Класс для обработки шифрования
        class QuestionEncryption {
            constructor() {
                this.key = ENCRYPTION_KEY;
            }
            
            encryptText(text) {
                try {
                    return CryptoJS.AES.encrypt(text, this.key).toString();
                } catch (error) {
                    console.error('Ошибка при шифровании текста:', error);
                    return null;
                }
            }
            
            decryptText(encryptedData) {
                try {
                    if (!encryptedData) {
                        console.error('Нет данных для расшифровки');
                        return null;
                    }
                    
                    const decrypted = CryptoJS.AES.decrypt(encryptedData, this.key);
                    const text = decrypted.toString(CryptoJS.enc.Utf8);
                    
                    if (!text) {
                        console.error('Не удалось расшифровать данные');
                        return null;
                    }
                    
                    return text;
                } catch (error) {
                    console.error('Ошибка при расшифровке текста:', error);
                    return null;
                }
            }
            
            async processQuestionsAsync(questions, progressCallback) {
                const processedQuestions = [];
                const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                
                for (let i = 0; i < questions.length; i++) {
                    try {
                        const question = questions[i];
                        const processed = this.processSingleQuestion(question, i, optionLetters);
                        processedQuestions.push(processed);
                        
                        // Обновляем прогресс
                        if (progressCallback) {
                            const progress = Math.round(((i + 1) / questions.length) * 100);
                            progressCallback(progress);
                        }
                    } catch (error) {
                        console.error(`Ошибка обработки вопроса ${i + 1}:`, error);
                        processedQuestions.push({
                            id: i + 1,
                            text: `Вопрос ${i + 1} (ошибка обработки)`,
                            options: ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'],
                            correctAnswer: 'A',
                            section: 'Ошибка',
                            explanation: 'Произошла ошибка при обработке вопроса',
                            difficulty: 'Средний'
                        });
                    }
                    
                    // Даем браузеру возможность обновить интерфейс
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
                
                return processedQuestions;
            }
            
            processSingleQuestion(question, index, optionLetters) {
                let correctAnswer = 'A';
                
                if (typeof question.correctAnswer === 'string' && /^[A-F]$/.test(question.correctAnswer)) {
                    correctAnswer = question.correctAnswer;
                } else if (typeof question.correctAnswer === 'number' && question.correctAnswer >= 0) {
                    correctAnswer = optionLetters[question.correctAnswer] || 'A';
                } else if (typeof question.correctAnswer === 'string' && /^\d+$/.test(question.correctAnswer)) {
                    const idx = parseInt(question.correctAnswer, 10);
                    correctAnswer = optionLetters[idx] || 'A';
                }
                
                const questionText = question.question || question.text || question.q || `Вопрос ${index + 1}`;
                const options = question.options || question.choices || question.answers || ['Нет вариантов ответа'];
                const section = question.section || '';
                const explanation = question.explanation || question.description || '';
                const difficulty = question.difficulty || 'Средний';
                
                return {
                    id: question.id || index + 1,
                    text: questionText,
                    options: options,
                    correctAnswer: correctAnswer,
                    section: section,
                    explanation: explanation,
                    difficulty: difficulty,
                    originalIndex: index // Сохраняем оригинальный индекс
                };
            }
            
            processRossetiFormat(jsonData) {
                console.log('Обработка формата Россети...');
                const questions = [];
                const sections = jsonData.sections || [];
                const optionLetters = ['A', 'B', 'C', 'D'];
                
                jsonData.questions.forEach((item, index) => {
                    try {
                        if (item.encryptedQuestion && Array.isArray(item.encryptedOptions)) {
                            const questionText = this.decryptText(item.encryptedQuestion) || `Вопрос ${index + 1}`;
                            
                            const options = item.encryptedOptions.map((encryptedOption, optIndex) => {
                                const decrypted = this.decryptText(encryptedOption);
                                return decrypted || `Вариант ${optionLetters[optIndex] || optIndex}`;
                            });
                            
                            const correctOptionIndex = item.correctOption !== undefined ? item.correctOption : 0;
                            const correctAnswer = optionLetters[correctOptionIndex] || 'A';
                            
                            const sectionIndex = item.section !== undefined ? item.section : 0;
                            let sectionName = 'Общие вопросы';
                            if (sections[sectionIndex] && sections[sectionIndex].name) {
                                sectionName = sections[sectionIndex].name;
                            }
                            
                            questions.push({
                                id: index + 1,
                                text: questionText,
                                options: options.length > 0 ? options : ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'],
                                correctAnswer: correctAnswer,
                                section: sectionName,
                                explanation: '',
                                difficulty: 'Средний',
                                originalIndex: index
                            });
                        }
                        else if (item.text || item.question) {
                            const questionText = item.text || item.question || `Вопрос ${index + 1}`;
                            const options = item.options || item.choices || ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'];
                            let correctAnswer = item.correctAnswer || 'A';
                            
                            if (typeof correctAnswer === 'number') {
                                correctAnswer = optionLetters[correctAnswer] || 'A';
                            } else if (typeof correctAnswer === 'string' && /^\d+$/.test(correctAnswer)) {
                                const idx = parseInt(correctAnswer, 10);
                                correctAnswer = optionLetters[idx] || 'A';
                            }
                            
                            let sectionName = item.section || 'Общие вопросы';
                            if (typeof item.section === 'number' && sections[item.section]) {
                                sectionName = sections[item.section].name || sectionName;
                            }
                            
                            questions.push({
                                id: index + 1,
                                text: questionText,
                                options: options,
                                correctAnswer: correctAnswer,
                                section: sectionName,
                                explanation: item.explanation || '',
                                difficulty: item.difficulty || 'Средний',
                                originalIndex: index
                            });
                        }
                    } catch (error) {
                        console.error(`Ошибка обработки вопроса ${index + 1}:`, error);
                        questions.push({
                            id: index + 1,
                            text: `Вопрос ${index + 1} (ошибка обработки)`,
                            options: ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'],
                            correctAnswer: 'A',
                            section: 'Ошибка',
                            explanation: 'Произошла ошибка при обработке вопроса',
                            difficulty: 'Средний',
                            originalIndex: index
                        });
                    }
                });
                
                console.log(`Успешно обработано ${questions.length} вопросов в формате Россети`);
                return questions;
            }
            
            processStandardEncryptedQuestions(encryptedQuestions) {
                const questions = [];
                const optionLetters = ['A', 'B', 'C', 'D'];
                
                encryptedQuestions.forEach((encryptedItem, index) => {
                    try {
                        if (encryptedItem.encrypted || encryptedItem.base64) {
                            const decryptedText = this.decryptText(encryptedItem.encrypted || encryptedItem.base64);
                            
                            if (decryptedText) {
                                try {
                                    const questionData = JSON.parse(decryptedText);
                                    const questionText = questionData.text || questionData.question || `Вопрос ${index + 1}`;
                                    const options = questionData.options || questionData.choices || ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'];
                                    let correctAnswer = questionData.correctAnswer || 'A';
                                    
                                    if (typeof correctAnswer === 'number') {
                                        correctAnswer = optionLetters[correctAnswer] || 'A';
                                    }
                                    
                                    questions.push({
                                        id: index + 1,
                                        text: questionText,
                                        options: options,
                                        correctAnswer: correctAnswer,
                                        section: questionData.section || 'Общие вопросы',
                                        explanation: questionData.explanation || '',
                                        difficulty: questionData.difficulty || 'Средний',
                                        originalIndex: index
                                    });
                                } catch (parseError) {
                                    questions.push({
                                        id: index + 1,
                                        text: decryptedText,
                                        options: ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'],
                                        correctAnswer: 'A',
                                        section: 'Общие вопросы',
                                        explanation: '',
                                        difficulty: 'Средний',
                                        originalIndex: index
                                    });
                                }
                            }
                        }
                        else if (encryptedItem.text || encryptedItem.question) {
                            const questionText = encryptedItem.text || encryptedItem.question || `Вопрос ${index + 1}`;
                            const options = encryptedItem.options || encryptedItem.choices || ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'];
                            let correctAnswer = encryptedItem.correctAnswer || 'A';
                            
                            if (typeof correctAnswer === 'number') {
                                correctAnswer = optionLetters[correctAnswer] || 'A';
                            }
                            
                            questions.push({
                                id: index + 1,
                                text: questionText,
                                options: options,
                                correctAnswer: correctAnswer,
                                section: encryptedItem.section || 'Общие вопросы',
                                explanation: encryptedItem.explanation || '',
                                difficulty: encryptedItem.difficulty || 'Средний',
                                originalIndex: index
                            });
                        }
                    } catch (error) {
                        console.error(`Ошибка обработки зашифрованного вопроса ${index + 1}:`, error);
                        questions.push({
                            id: index + 1,
                            text: `Вопрос ${index + 1} (ошибка расшифровки)`,
                            options: ['Вариант A', 'Вариант B', 'Вариант C', 'Вариант D'],
                            correctAnswer: 'A',
                            section: 'Ошибка',
                            explanation: 'Произошла ошибка при расшифровке',
                            difficulty: 'Средний',
                            originalIndex: index
                        });
                    }
                });
                
                return questions;
            }
            
            async processEncryptedFileAsync(jsonData) {
                console.log('Асинхронная обработка файла с вопросами...');
                
                if (!jsonData.questions || !Array.isArray(jsonData.questions)) {
                    console.error('Нет вопросов или questions не является массивом');
                    return null;
                }
                
                testState.sections = jsonData.sections || [];
                
                if (jsonData.encryption === "AES") {
                    const firstQuestion = jsonData.questions[0];
                    if (firstQuestion && firstQuestion.encryptedQuestion && Array.isArray(firstQuestion.encryptedOptions)) {
                        console.log('Обнаружен формат Россети с AES шифрованием');
                        return this.processRossetiFormat(jsonData);
                    } else {
                        console.log('Обнаружен стандартный AES формат');
                        return this.processStandardEncryptedQuestions(jsonData.questions);
                    }
                } else if (jsonData.encryption === "Base64" || jsonData.encryption === "base64") {
                    console.log('Обнаружен Base64 формат');
                    return this.processStandardEncryptedQuestions(jsonData.questions);
                } else {
                    const firstQuestion = jsonData.questions[0];
                    
                    if (firstQuestion && firstQuestion.encryptedQuestion && Array.isArray(firstQuestion.encryptedOptions)) {
                        console.log('Автоопределение: формат Россети');
                        return this.processRossetiFormat(jsonData);
                    } else if (firstQuestion && (firstQuestion.encrypted || firstQuestion.base64)) {
                        console.log('Автоопределение: зашифрованные вопросы');
                        return this.processStandardEncryptedQuestions(jsonData.questions);
                    } else {
                        console.log('Незашифрованный файл, асинхронная обработка');
                        return await this.processQuestionsAsync(jsonData.questions, (progress) => {
                            elements.loadingProgress.textContent = `${progress}%`;
                        });
                    }
                }
            }
        }
        
        const encryption = new QuestionEncryption();
        
        // Основные функции
        class TestSystem {
            constructor() {
                this.isOnline = navigator.onLine;
                this.setupEventListeners();
                this.setupProtection();
                this.setupVisibilityChange();
                this.setupOnlineStatus();
                this.setupTestSettings();
            }
            
            setupEventListeners() {
                // Загрузка файлов
                elements.uploadArea.addEventListener('click', () => elements.jsonFileInput.click());
                elements.jsonFileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                elements.downloadExampleBtn.addEventListener('click', () => this.downloadExampleRossetiFile());
                
                // Drag and drop
                elements.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    elements.uploadArea.classList.add('dragover');
                });
                
                elements.uploadArea.addEventListener('dragleave', () => {
                    elements.uploadArea.classList.remove('dragover');
                });
                
                elements.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    elements.uploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length > 0) {
                        this.handleFileUpload({ target: { files: e.dataTransfer.files } });
                    }
                });
                
                // Навигация
                elements.proceedToTestBtn.addEventListener('click', () => this.proceedToTest());
                elements.backToUploadBtn.addEventListener('click', () => this.backToUpload());
                elements.configureTestBtn.addEventListener('click', () => this.showTestSettings());
                elements.backToUserInfoBtn.addEventListener('click', () => this.backToUserInfo());
                elements.saveSettingsBtn.addEventListener('click', () => this.handleStartTest());
                elements.newTestBtn.addEventListener('click', () => this.showPasswordModal());
                
                // Настройки теста
                elements.timeLimitSlider.addEventListener('input', (e) => this.handleTimeSliderChange(e));
                elements.timeLimitInput.addEventListener('input', (e) => this.handleTimeInputChange(e));
                elements.timeLimitInput.addEventListener('change', (e) => this.validateTimeInput(e));
                elements.shuffleQuestionsCheckbox.addEventListener('change', (e) => this.handleShuffleChange(e));
                elements.startPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleStartTest();
                });
                
                // Экспорт
                elements.exportWordOfflineBtn.addEventListener('click', () => this.exportToWordOffline());
                elements.exportWordOfflineReview.addEventListener('click', () => this.exportToWordOffline());
                elements.exportExcelBtn.addEventListener('click', () => this.exportToExcelXLSX());
                elements.exportExcelReview.addEventListener('click', () => this.exportToExcelXLSX());
                
                // Результаты
                elements.reviewTestBtn.addEventListener('click', () => this.showReviewSection());
                elements.reviewToResults.addEventListener('click', () => this.showResultsPanel());
                elements.viewDetailedResultsBtn.addEventListener('click', () => this.showDetailedResults());
                elements.backToSummaryBtn.addEventListener('click', () => this.showResultsPanel());
                elements.backToSummaryBottomBtn.addEventListener('click', () => this.showResultsPanel());
                elements.toggleStatsBtn.addEventListener('click', () => this.toggleExtendedStats());
                
                // Навигация по просмотру
                elements.reviewPrev.addEventListener('click', () => {
                    if (testState.currentReviewQuestion > 1) {
                        testState.currentReviewQuestion--;
                        this.showReviewQuestion();
                    }
                });
                
                elements.reviewNext.addEventListener('click', () => {
                    if (testState.currentReviewQuestion < testState.totalQuestions) {
                        testState.currentReviewQuestion++;
                        this.showReviewQuestion();
                    }
                });
                
                // Пропущенные вопросы
                elements.answerUnansweredBtn.addEventListener('click', () => this.handleAnswerUnanswered());
                elements.skipUnansweredBtn.addEventListener('click', () => this.handleSkipUnanswered());
                
                // Пароли
                elements.confirmPasswordBtn.addEventListener('click', () => this.handleConfirmPassword());
                elements.cancelPasswordBtn.addEventListener('click', () => this.hidePasswordModal());
                elements.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleConfirmPassword();
                });
                
                // Навигация по вопросам
                elements.jumpBtn.addEventListener('click', () => this.toggleJumpDropdown());
                elements.bookmarksBtn.addEventListener('click', () => this.toggleBookmarksDropdown());
                
                // Закрытие выпадающих списков при клике вне их
                document.addEventListener('click', (e) => {
                    if (!elements.jumpBtn.contains(e.target) && !elements.jumpDropdown.contains(e.target)) {
                        elements.jumpDropdown.classList.remove('active');
                    }
                    if (!elements.bookmarksBtn.contains(e.target) && !elements.bookmarksDropdown.contains(e.target)) {
                        elements.bookmarksDropdown.classList.remove('active');
                    }
                });
                
                // Продолжение теста после паузы
                elements.continueTestBtn.addEventListener('click', () => this.resumeTest());
            }
            
            setupProtection() {
                // Запрет контекстного меню
                document.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    return false;
                });
                
                // Запрет горячих клавиш
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'F5' || 
                        (e.ctrlKey && e.key === 'r') || 
                        (e.ctrlKey && e.shiftKey && e.key === 'r') ||
                        (e.ctrlKey && e.key === 'R')) {
                        e.preventDefault();
                        this.showRefreshWarning();
                        return false;
                    }
                    
                    if (e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.key === 'U') ||
                        (e.ctrlKey && e.key === 'S') ||
                        (e.ctrlKey && e.key === 'p') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J')) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Защита от обновления страницы
                window.addEventListener('beforeunload', (e) => {
                    if (testState.userName && testState.timeLeft < testState.timeLimit) {
                        const confirmationMessage = 'Вы уверены, что хотите покинуть страницу? Весь прогресс теста будет потерян.';
                        e.returnValue = confirmationMessage;
                        return confirmationMessage;
                    }
                });
                
                // Предотвращение сохранения паролей
                document.querySelectorAll('input[type="password"]').forEach(input => {
                    input.setAttribute('autocomplete', 'new-password');
                    input.setAttribute('autocorrect', 'off');
                    input.setAttribute('autocapitalize', 'off');
                    input.setAttribute('spellcheck', 'false');
                    input.value = '';
                });
            }
            
            setupVisibilityChange() {
                // Пауза теста при неактивной вкладке
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && testState.timer && !testState.isPaused) {
                        this.pauseTest();
                    } else if (!document.hidden && testState.isPaused) {
                        this.resumeTest();
                    }
                });
            }
            
            setupOnlineStatus() {
                // Отслеживание онлайн статуса
                window.addEventListener('online', () => {
                    testState.isOnline = true;
                    this.updateOnlineStatus(true);
                });
                
                window.addEventListener('offline', () => {
                    testState.isOnline = false;
                    this.updateOnlineStatus(false);
                });
                
                this.updateOnlineStatus(testState.isOnline);
            }
            
            setupTestSettings() {
                // Установка начальных значений
                const timeLimit = localStorage.getItem('testTimeLimit');
                if (timeLimit) {
                    const timeLimitInt = parseInt(timeLimit, 10);
                    if (timeLimitInt >= 1 && timeLimitInt <= 999) {
                        elements.timeLimitSlider.value = timeLimitInt;
                        elements.timeLimitInput.value = timeLimitInt;
                        this.updateTimeDisplay(timeLimitInt);
                    }
                }
                
                const shuffleEnabled = localStorage.getItem('testShuffleEnabled');
                if (shuffleEnabled) {
                    elements.shuffleQuestionsCheckbox.checked = shuffleEnabled === 'true';
                }
            }
            
            updateOnlineStatus(isOnline) {
                if (isOnline) {
                    elements.offlineNotification.style.display = 'none';
                    elements.connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Онлайн';
                    elements.connectionStatus.style.color = '#27ae60';
                } else {
                    elements.offlineNotification.style.display = 'block';
                    elements.connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Офлайн';
                    elements.connectionStatus.style.color = '#e74c3c';
                    
                    // Скрываем через 5 секунд
                    setTimeout(() => {
                        elements.offlineNotification.style.display = 'none';
                    }, 5000);
                }
            }
            
            handleTimeSliderChange(e) {
                const value = parseInt(e.target.value, 10);
                elements.timeLimitInput.value = value;
                this.updateTimeDisplay(value);
            }
            
            handleTimeInputChange(e) {
                let value = parseInt(e.target.value, 10);
                
                // Ограничиваем значение
                if (isNaN(value)) value = 60;
                if (value < 1) value = 1;
                if (value > 999) value = 999;
                
                elements.timeLimitSlider.value = value;
                elements.timeLimitInput.value = value;
                this.updateTimeDisplay(value);
            }
            
            validateTimeInput(e) {
                let value = parseInt(e.target.value, 10);
                
                if (isNaN(value) || value < 1) {
                    value = 1;
                } else if (value > 999) {
                    value = 999;
                }
                
                elements.timeLimitSlider.value = value;
                elements.timeLimitInput.value = value;
                this.updateTimeDisplay(value);
            }
            
            updateTimeDisplay(minutes) {
                let displayText = `Время теста: ${minutes} минут`;
                
                if (minutes >= 60) {
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    
                    if (remainingMinutes === 0) {
                        displayText = `Время теста: ${hours} час${hours > 1 ? 'а' : ''}`;
                    } else {
                        displayText = `Время теста: ${hours} час${hours > 1 ? 'а' : ''} ${remainingMinutes} минут`;
                    }
                }
                
                elements.timeDisplayText.textContent = displayText;
            }
            
            handleShuffleChange(e) {
                // Ничего не делаем, просто сохраняем состояние
                console.log('Перемешивание вопросов:', e.target.checked);
            }
            
            validateJSONStructure(jsonData) {
                if (!jsonData || typeof jsonData !== 'object') {
                    console.error('Некорректный JSON объект');
                    return false;
                }
                
                const hasQuestions = 
                    (jsonData.questions && Array.isArray(jsonData.questions)) ||
                    (jsonData.test && Array.isArray(jsonData.test)) ||
                    (jsonData.items && Array.isArray(jsonData.items));
                
                if (!hasQuestions) {
                    console.error('Нет вопросов в файле');
                    return false;
                }
                
                let questionsArray = [];
                if (jsonData.questions) questionsArray = jsonData.questions;
                else if (jsonData.test) questionsArray = jsonData.test;
                else if (jsonData.items) questionsArray = jsonData.items;
                
                if (questionsArray.length === 0) {
                    console.error('Массив вопросов пуст');
                    return false;
                }
                
                // Проверка первого вопроса на корректность
                const firstQuestion = questionsArray[0];
                if (!firstQuestion || typeof firstQuestion !== 'object') {
                    console.error('Первый вопрос некорректен');
                    return false;
                }
                
                return true;
            }
            
            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                elements.uploadSuccess.style.display = 'none';
                elements.uploadError.style.display = 'none';
                elements.uploadedFileInfo.style.display = 'none';
                
                if (!file.name.endsWith('.json')) {
                    this.showUploadError('Файл должен быть в формате JSON');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    this.showUploadError('Файл слишком большой (максимум 10MB)');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        console.log('Загруженный JSON:', jsonData);
                        
                        if (!this.validateJSONStructure(jsonData)) {
                            this.showUploadError('Неверная структура JSON файла');
                            return;
                        }
                        
                        // Показываем индикатор загрузки
                        elements.loadingQuestions.style.display = 'flex';
                        
                        testState.testTitle = jsonData.testTitle || 'Тестовая система "РОССЕТИ ЮГ"';
                        testState.sections = jsonData.sections || [];
                        
                        // Асинхронная обработка вопросов
                        const questions = await encryption.processEncryptedFileAsync(jsonData);
                        
                        elements.loadingQuestions.style.display = 'none';
                        
                        if (!questions || questions.length === 0) {
                            this.showUploadError('Не удалось загрузить вопросы из файла');
                            return;
                        }
                        
                        console.log('Успешно загружено вопросов:', questions.length);
                        
                        // Сохраняем оригинальные вопросы
                        testState.originalQuestions = [...questions];
                        testState.questions = [...questions];
                        
                        document.querySelector('header h1').innerHTML = `<i class="fas fa-bolt"></i> "${testState.testTitle}"`;
                        document.title = testState.testTitle;
                        
                        this.showFileInfo(file, jsonData, testState.questions.length);
                        
                        elements.proceedToTestBtn.style.display = 'block';
                        elements.uploadSuccess.style.display = 'block';
                        
                    } catch (error) {
                        elements.loadingQuestions.style.display = 'none';
                        console.error('Ошибка при обработке файла:', error);
                        this.showUploadError('Ошибка при обработке файла: ' + error.message);
                    }
                };
                
                reader.onerror = () => {
                    elements.loadingQuestions.style.display = 'none';
                    this.showUploadError('Ошибка при чтении файла');
                };
                
                reader.readAsText(file);
            }
            
            showFileInfo(file, jsonData, actualQuestionsCount) {
                const fileSize = (file.size / 1024).toFixed(2);
                
                let questionsInFile = 0;
                if (jsonData.questions) questionsInFile = jsonData.questions.length;
                else if (jsonData.test) questionsInFile = jsonData.test.length;
                else if (jsonData.items) questionsInFile = jsonData.items.length;
                
                const sectionsCount = jsonData.sections ? jsonData.sections.length : 0;
                
                let encryptionType = 'Отсутствует';
                if (jsonData.encryption) {
                    encryptionType = jsonData.encryption.toUpperCase();
                } else if (questionsInFile > 0) {
                    let firstQuestion = [];
                    if (jsonData.questions) firstQuestion = jsonData.questions[0];
                    else if (jsonData.test) firstQuestion = jsonData.test[0];
                    else if (jsonData.items) firstQuestion = jsonData.items[0];
                    
                    if (firstQuestion) {
                        if (firstQuestion.encryptedQuestion && Array.isArray(firstQuestion.encryptedOptions)) {
                            encryptionType = 'РОССЕТИ (AES)';
                        } else if (firstQuestion.encrypted || firstQuestion.base64) {
                            encryptionType = 'Зашифровано (неизвестный тип)';
                        }
                    }
                }
                
                elements.fileInfoContent.innerHTML = `
                    <strong>Имя файла:</strong> ${file.name}<br>
                    <strong>Размер:</strong> ${fileSize} KB<br>
                    <strong>Количество вопросов в файе:</strong> ${questionsInFile}<br>
                    <strong>Загружено вопросов:</strong> ${actualQuestionsCount}<br>
                    <strong>Формат:</strong> ${encryptionType}<br>
                    ${sectionsCount > 0 ? `<strong>Количество разделов:</strong> ${sectionsCount}<br>` : ''}
                    <strong>Название теста:</strong> ${jsonData.testTitle || 'Не указано'}<br>
                    <strong>Описание:</strong> ${jsonData.testDescription || 'Не указано'}<br>
                    <strong>Дата загрузки:</strong> ${new Date().toLocaleDateString('ru-RU')}
                `;
                
                elements.uploadedFileInfo.style.display = 'block';
            }
            
            showUploadError(message) {
                elements.uploadError.textContent = `❌ ${message}`;
                elements.uploadError.style.display = 'block';
                elements.proceedToTestBtn.style.display = 'none';
            }
            
            

            // ============ КАТАЛОГ ТЕСТОВ (папка /test) ============
            async loadTestCatalog() {
                // Если элемента нет — ничего не делаем
                if (!elements.availableTestsContainer || !elements.availableTestsList) return;

                // Пытаемся загрузить манифест. Если его нет — просто скрываем каталог.
                try {
                    const response = await fetch('test/manifest.json', { cache: 'no-store' });
                    if (!response.ok) {
                        elements.availableTestsContainer.style.display = 'none';
                        return;
                    }

                    const manifest = await response.json();
                    if (!Array.isArray(manifest) || manifest.length === 0) {
                        elements.availableTestsContainer.style.display = 'none';
                        return;
                    }

                    // Рендерим список тестов
                    elements.availableTestsList.innerHTML = '';
                    manifest.forEach((item) => {
                        const fileName = (item && item.file) ? String(item.file) : '';
                        if (!fileName) return;

                        const displayName = (item && item.name) ? String(item.name) : fileName;

                        const btn = document.createElement('button');
                        btn.className = 'btn btn-primary';
                        btn.style.width = '100%';
                        btn.style.marginTop = '12px';
                        btn.innerHTML = `<i class="fas fa-file-code"></i> ${displayName}`;
                        btn.addEventListener('click', () => this.loadTestFromCatalog(fileName));

                        elements.availableTestsList.appendChild(btn);
                    });

                    elements.availableTestsContainer.style.display = 'block';
                } catch (e) {
                    // Если fetch невозможен (например, file://), просто не показываем каталог
                    elements.availableTestsContainer.style.display = 'none';
                }
            }

            async loadTestFromCatalog(fileName) {
                try {
                    elements.uploadSuccess.style.display = 'none';
                    elements.uploadError.style.display = 'none';
                    elements.uploadedFileInfo.style.display = 'none';

                    // Показываем индикатор загрузки
                    elements.loadingQuestions.style.display = 'flex';

                    const response = await fetch(`test/${encodeURIComponent(fileName)}`, { cache: 'no-store' });
                    if (!response.ok) {
                        elements.loadingQuestions.style.display = 'none';
                        this.showUploadError('Не удалось загрузить файл из папки test');
                        return;
                    }

                    const text = await response.text();
                    const jsonData = JSON.parse(text);

                    if (!this.validateJSONStructure(jsonData)) {
                        elements.loadingQuestions.style.display = 'none';
                        this.showUploadError('Неверная структура JSON файла');
                        return;
                    }

                    testState.testTitle = jsonData.testTitle || 'Тестовая система ПАО "РОССЕТИ ЮГ"';
                    testState.sections = jsonData.sections || [];

                    // Асинхронная обработка вопросов (включая шифрование/форматы Россети)
                    const questions = await encryption.processEncryptedFileAsync(jsonData);

                    elements.loadingQuestions.style.display = 'none';

                    if (!questions || questions.length === 0) {
                        this.showUploadError('Не удалось загрузить вопросы из файла');
                        return;
                    }

                    // Сохраняем оригинальные вопросы
                    testState.originalQuestions = [...questions];
                    testState.questions = [...questions];

                    document.querySelector('header h1').innerHTML = `<i class="fas fa-bolt"></i> "${testState.testTitle}"`;
                    document.title = testState.testTitle;

                    // Синтетическая информация о файле
                    const fakeFile = {
                        name: fileName,
                        size: text.length
                    };

                    this.showFileInfo(fakeFile, jsonData, testState.questions.length);

                    elements.proceedToTestBtn.style.display = 'block';
                    elements.uploadSuccess.style.display = 'block';

                } catch (error) {
                    elements.loadingQuestions.style.display = 'none';
                    console.error('Ошибка при загрузке файла из каталога:', error);
                    this.showUploadError('Ошибка при обработке файла: ' + error.message);
                }
            }

proceedToTest() {
                elements.jsonUploadContainer.style.display = 'none';
                elements.userInfoForm.style.display = 'block';
                
                if (testState.questions.length > 0) {
                    elements.questionsCount.textContent = testState.questions.length + ' вопросов';
                }
                
                document.querySelector('#user-info-form h3').innerHTML = `<i class="fas fa-user"></i> ${testState.testTitle}`;
            }
            
            backToUpload() {
                elements.userInfoForm.style.display = 'none';
                elements.jsonUploadContainer.style.display = 'block';
                
                elements.jsonFileInput.value = '';
                elements.uploadSuccess.style.display = 'none';
                elements.uploadedFileInfo.style.display = 'none';
                elements.proceedToTestBtn.style.display = 'none';
            }
            
            showTestSettings() {
                const userName = document.getElementById('user-name').value.trim();
                const userPosition = document.getElementById('user-position').value.trim();
                const userDepartment = document.getElementById('user-department').value.trim();
                
                if (!userName) {
                    alert('Пожалуйста, введите ФИО');
                    return;
                }
                
                // Получаем выбранный режим тестирования
                const testMode = document.querySelector('input[name="test-mode"]:checked').value;
                
                testState.userName = userName;
                testState.userPosition = userPosition;
                testState.userDepartment = userDepartment;
                testState.testMode = testMode; // Сохраняем режим тестирования
                
                elements.userInfoForm.style.display = 'none';
                elements.testSettingsForm.style.display = 'block';
            }
            
            backToUserInfo() {
                elements.testSettingsForm.style.display = 'none';
                elements.userInfoForm.style.display = 'block';
            }
            
            async downloadExampleRossetiFile() {
                try {
                    const exampleQuestions = [
                        {
                            text: "Какое напряжение является стандартным для бытовых сетей в России?",
                            options: ["110 В", "220 В", "380 В", "660 В"],
                            correctAnswer: "B",
                            section: "Основы электроэнергетики",
                            explanation: "В России стандартное напряжение в бытовых сетях составляет 220 В.",
                            difficulty: "Легкий"
                        },
                        {
                            text: "Что такое АСКУЭ?",
                            options: [
                                "Автоматизированная система контроля учета электроэнергии",
                                "Аварийная система контроля уровня энергии",
                                "Автоматическая система коммутации устройств электропитания",
                                "Аналитическая система контроля уровня эффективности"
                            ],
                            correctAnswer: "A",
                            section: "АСКУЭ и телеметрия",
                            explanation: "АСКУЭ - это Автоматизированная система контроля учета электроэнергии.",
                            difficulty: "Средний"
                        }
                    ];
                    
                    const exampleData = {
                        testTitle: "Тест для инженеров АСКУЭ и энергетиков",
                        testDescription: "Комплексная проверка знаний в области автоматизированных систем коммерческого учёта электроэнергии с улучшенным функционалом",
                        sections: [
                            {
                                name: "Основы электроэнергетики",
                                icon: "fa-bolt"
                            },
                            {
                                name: "Метрология и измерения",
                                icon: "fa-ruler"
                            },
                            {
                                name: "АСКУЭ и телеметрия",
                                icon: "fa-satellite-dish"
                            }
                        ],
                        questions: exampleQuestions,
                        version: "2.0",
                        createdAt: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(exampleData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'пример_файла_россети_улучшенный.json';
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                } catch (error) {
                    console.error('Ошибка при создании примера файла:', error);
                    alert('Произошла ошибка при создании примера файла: ' + error.message);
                }
            }
            
            showRefreshWarning() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    text-align: center;
                    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
                `;
                
                modalContent.innerHTML = `
                    <h2 style="color: #e74c3c; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i> Внимание!
                    </h2>
                    <p style="font-size: 16px; margin-bottom: 20px;">
                        Обновление страницы во время тестирования запрещено!<br>
                        Весь прогресс теста будет потерян.
                    </p>
                    <p style="font-size: 14px; color: #666; margin-bottom: 25px;">
                        Для завершения теста используйте кнопку "Завершить тест".
                    </p>
                    <button id="close-warning" style="
                        background: #2d5cc2;
                        color: white;
                        border: none;
                        padding: 10px 30px;
                        border-radius: 5px;
                        font-size: 16px;
                        cursor: pointer;
                    ">
                        <i class="fas fa-check"></i> Понятно
                    </button>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                document.getElementById('close-warning').addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
                
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                }, 5000);
            }
            
            handleStartTest() {
                const startPassword = elements.startPasswordInput.value.trim();
                
                if (!startPassword) {
                    alert('Пожалуйста, введите пароль для запуска теста');
                    return;
                }
                
                if (startPassword !== userPasswords.start && startPassword !== userPasswords.admin) {
                    alert('Неверный пароль для запуска теста');
                    elements.startPasswordInput.value = '';
                    return;
                }
                
                if (!testState.questions || testState.questions.length === 0) {
                    console.error('Вопросы не загружены:', testState);
                    alert('В системе нет вопросов для тестирования. Пожалуйста, загрузите файл с вопросами.');
                    this.backToUpload();
                    return;
                }
                
                const firstQuestion = testState.questions[0];
                console.log('Первый вопрос для проверки:', firstQuestion);
                
                if (!firstQuestion || !firstQuestion.text || !Array.isArray(firstQuestion.options)) {
                    console.error('Некорректная структура вопроса:', firstQuestion);
                    alert('Ошибка в структуре вопросов. Пожалуйста, проверьте файл.');
                    this.backToUpload();
                    return;
                }
                
                // Сохраняем настройки теста
                const timeLimitMinutes = parseInt(elements.timeLimitInput.value, 10);
                const shuffleEnabled = elements.shuffleQuestionsCheckbox.checked;
                
                testState.timeLimit = timeLimitMinutes * 60; // Конвертируем в секунды
                testState.timeLeft = testState.timeLimit;
                testState.shuffleQuestions = shuffleEnabled;
                testState.testSettings = {
                    timeLimit: timeLimitMinutes,
                    shuffleEnabled: shuffleEnabled,
                    testMode: testState.testMode
                };
                
                // Сохраняем настройки в localStorage
                localStorage.setItem('testTimeLimit', timeLimitMinutes);
                localStorage.setItem('testShuffleEnabled', shuffleEnabled);
                
                testState.startTime = new Date();
                testState.questionResults = [];
                testState.sectionStats = {};
                testState.extendedStats = {};
                testState.totalQuestions = testState.questions.length;
                testState.testId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                
                // Инициализация аналитики времени
                testState.questionTimers = {};
                testState.questionStartTime = null;
                testState.currentQuestionTime = 0;
                
                // Инициализация блокировки ответов
                testState.answeredLocked = {};
                
                // Инициализация истории тренировочного режима
                testState.trainingHistory = {};
                
                // Применяем перемешивание, если включено
                if (shuffleEnabled) {
                    this.shuffleQuestions();
                    elements.shuffleStatus.textContent = 'Случайный порядок';
                } else {
                    // Восстанавливаем оригинальный порядок
                    testState.questions = [...testState.originalQuestions];
                    elements.shuffleStatus.textContent = 'Стандартный порядок';
                }
                
                // Создаем DOM для вопросов
                this.createQuestionsInDOM();
                
                console.log('Запуск теста с количеством вопросов:', testState.totalQuestions);
                console.log('Настройки теста:', testState.testSettings);
                console.log('Режим тестирования:', testState.testMode);
                
                elements.testSettingsForm.style.display = 'none';
                elements.testInfo.style.display = 'flex';
                elements.progressContainer.style.display = 'block';
                elements.timerContainer.style.display = 'flex';
                elements.jumpToQuestion.style.display = 'block';
                elements.bookmarkedQuestions.style.display = 'block';
                
                elements.questionsCount.textContent = testState.totalQuestions + ' вопросов';
                elements.testTimeLimit.textContent = timeLimitMinutes + ' минут';
                
                // Если режим тренировки, отключаем таймер
                if (testState.testMode === 'training') {
                    elements.timerContainer.style.display = 'none';
                    testState.timeLimit = 999999; // Очень большое время для тренировки
                    testState.timeLeft = 999999;
                }
                
                this.startTimer();
                this.showQuestion(1);
            }
            
            shuffleQuestions() {
                console.log('Перемешивание вопросов...');
                
                // Создаем копию оригинальных вопросов
                const questionsToShuffle = [...testState.originalQuestions];
                
                // Алгоритм Фишера-Йетса для перемешивания
                for (let i = questionsToShuffle.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [questionsToShuffle[i], questionsToShuffle[j]] = [questionsToShuffle[j], questionsToShuffle[i]];
                }
                
                // Сохраняем перемешанные вопросы
                testState.questions = questionsToShuffle;
                
                console.log('Вопросы перемешаны. Первый вопрос:', testState.questions[0]);
            }
            
            createQuestionsInDOM() {
                elements.allQuestionsContainer.innerHTML = '';
                
                if (!testState.questions || testState.questions.length === 0) {
                    console.error('Нет вопросов для отображения');
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = '#e74c3c';
                    errorDiv.style.padding = '20px';
                    errorDiv.style.textAlign = 'center';
                    errorDiv.textContent = 'Ошибка: вопросы не загружены';
                    elements.allQuestionsContainer.appendChild(errorDiv);
                    return;
                }
                
                console.log('Создание DOM для вопросов:', testState.questions.length);
                
                const questionsBySection = {};
                
                testState.questions.forEach((question, index) => {
                    const sectionName = question.section || 'Общие вопросы';
                    if (!questionsBySection[sectionName]) {
                        questionsBySection[sectionName] = [];
                    }
                    questionsBySection[sectionName].push({...question, displayIndex: index + 1});
                });
                
                Object.keys(questionsBySection).forEach(sectionName => {
                    const sectionQuestions = questionsBySection[sectionName];
                    
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'test-section';
                    sectionDiv.id = `section-${sectionName.replace(/\s+/g, '-')}`;
                    
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'section-title';
                    
                    let sectionIcon = 'fa-folder';
                    if (testState.sections && testState.sections.length > 0) {
                        const matchedSection = testState.sections.find(s => s.name === sectionName);
                        if (matchedSection && matchedSection.icon) {
                            sectionIcon = matchedSection.icon;
                        }
                    }
                    
                    sectionTitle.innerHTML = `<i class="fas ${sectionIcon}"></i> ${sectionName} (${sectionQuestions.length} вопросов)`;
                    
                    sectionDiv.appendChild(sectionTitle);
                    
                    sectionQuestions.forEach(questionData => {
                        const questionNumber = questionData.displayIndex;
                        sectionDiv.appendChild(this.createQuestionElement(questionData, questionNumber));
                    });
                    
                    elements.allQuestionsContainer.appendChild(sectionDiv);
                });
            }
            
            createQuestionElement(question, number) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.setAttribute('data-number', number);
                questionDiv.setAttribute('data-correct', question.correctAnswer);
                
                const questionText = document.createElement('div');
                questionText.className = 'question-text';
                questionText.textContent = question.text;
                
                // Добавляем индикатор сложности
                if (question.difficulty) {
                    const difficultySpan = document.createElement('span');
                    let difficultyClass = 'difficulty-medium';
                    if (question.difficulty.toLowerCase() === 'легкий') difficultyClass = 'difficulty-easy';
                    if (question.difficulty.toLowerCase() === 'сложный') difficultyClass = 'difficulty-hard';
                    
                    difficultySpan.className = `difficulty-indicator ${difficultyClass}`;
                    difficultySpan.textContent = question.difficulty;
                    questionText.appendChild(difficultySpan);
                }
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options';
                
                const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';
                    optionDiv.setAttribute('data-value', optionLetters[index]);
                    
                    const optionLetter = document.createElement('span');
                    optionLetter.className = 'option-letter';
                    optionLetter.textContent = optionLetters[index];
                    
                    const optionText = document.createElement('span');
                    optionText.textContent = option;
                    
                    optionDiv.appendChild(optionLetter);
                    optionDiv.appendChild(optionText);
                    optionsDiv.appendChild(optionDiv);
                });
                
                questionDiv.appendChild(questionText);
                questionDiv.appendChild(optionsDiv);
                
                return questionDiv;
            }
            
            startTimer() {
                this.updateTimerDisplay();
                
                testState.timer = setInterval(() => {
                    if (!testState.isPaused) {
                        testState.timeLeft--;
                        this.updateTimerDisplay();
                        
                        if (testState.timeLeft <= 0) {
                            clearInterval(testState.timer);
                            this.handleCheckTest();
                            alert('Время вышло! Тест завершен автоматически.');
                        }
                    }
                }, 1000);
            }
            
            updateTimerDisplay() {
                const minutes = Math.floor(testState.timeLeft / 60);
                const seconds = testState.timeLeft % 60;
                elements.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const totalTime = testState.timeLimit;
                const progress = ((totalTime - testState.timeLeft) / totalTime) * 100;
                elements.progressBar.style.width = `${progress}%`;
                
                if (testState.timeLeft <= 60) {
                    elements.timer.classList.add('danger');
                } else if (testState.timeLeft <= 300) {
                    elements.timer.classList.add('warning');
                }
            }
            
            pauseTest() {
                if (testState.timer && !testState.isPaused) {
                    testState.isPaused = true;
                    elements.pauseOverlay.style.display = 'flex';
                    elements.pauseTimer.textContent = elements.timer.textContent;
                    
                    // Останавливаем таймер для текущего вопроса
                    if (testState.questionTimer) {
                        clearInterval(testState.questionTimer);
                    }
                    
                    // Останавливаем таймер автоматического перехода
                    if (testState.autoTransitionTimer) {
                        clearTimeout(testState.autoTransitionTimer);
                        testState.autoTransitionTimer = null;
                    }
                }
            }
            
            resumeTest() {
                if (testState.isPaused) {
                    testState.isPaused = false;
                    elements.pauseOverlay.style.display = 'none';
                    
                    // Перезапускаем таймер для текущего вопроса
                    if (testState.currentQuestion) {
                        this.startQuestionTimer();
                    }
                }
            }
            
            startQuestionTimer() {
                // Останавливаем предыдущий таймер, если он был
                if (testState.questionTimer) {
                    clearInterval(testState.questionTimer);
                }
                
                // Сбрасываем время для текущего вопроса
                testState.currentQuestionTime = 0;
                
                // Запускаем новый таймер
                testState.questionTimer = setInterval(() => {
                    if (!testState.isPaused) {
                        testState.currentQuestionTime++;
                        this.updateQuestionTimeIndicator();
                    }
                }, 1000);
            }
            
            updateQuestionTimeIndicator() {
                const questionContainer = document.querySelector('.single-question-container');
                if (!questionContainer) return;
                
                // Удаляем старый индикатор, если он есть
                const oldIndicator = document.getElementById('question-time-indicator');
                if (oldIndicator) {
                    oldIndicator.remove();
                }
                
                // Создаем новый индикатор
                const timeIndicator = document.createElement('div');
                timeIndicator.id = 'question-time-indicator';
                timeIndicator.className = 'question-time-indicator';
                
                // Определяем уровень предупреждения
                let warningLevel = TIME_WARNING_LEVELS.GREEN;
                let icon = 'fa-check-circle';
                let message = 'Оптимальное время';
                
                if (testState.currentQuestionTime >= TIME_WARNING_LEVELS.YELLOW.min && 
                    testState.currentQuestionTime < TIME_WARNING_LEVELS.YELLOW.max) {
                    warningLevel = TIME_WARNING_LEVELS.YELLOW;
                    icon = 'fa-exclamation-triangle';
                    message = 'Время увеличивается';
                } else if (testState.currentQuestionTime >= TIME_WARNING_LEVELS.RED.min) {
                    warningLevel = TIME_WARNING_LEVELS.RED;
                    icon = 'fa-exclamation-circle';
                    message = 'Слишком долго!';
                    
                    // Добавляем анимацию мигания для контейнера вопроса
                    if (!questionContainer.classList.contains('warning-pulse')) {
                        questionContainer.classList.add('warning-pulse');
                    }
                } else {
                    // Убираем анимацию мигания, если время нормальное
                    questionContainer.classList.remove('warning-pulse');
                }
                
                timeIndicator.classList.add(warningLevel.color);
                timeIndicator.innerHTML = `<i class="fas ${icon}"></i> Время на вопрос: ${testState.currentQuestionTime} сек. - ${message}`;
                
                // Вставляем индикатор после section-indicator
                const sectionIndicator = questionContainer.querySelector('.section-indicator');
                if (sectionIndicator) {
                    sectionIndicator.parentNode.insertBefore(timeIndicator, sectionIndicator.nextSibling);
                }
            }
            
            showQuestion(questionNumber) {
                // Останавливаем предыдущий таймер автоматического перехода
                if (testState.autoTransitionTimer) {
                    clearTimeout(testState.autoTransitionTimer);
                    testState.autoTransitionTimer = null;
                }
                
                // Останавливаем таймер для предыдущего вопроса и сохраняем время
                if (testState.questionTimer) {
                    clearInterval(testState.questionTimer);
                    
                    // Сохраняем время, затраченное на предыдущий вопрос
                    if (testState.currentQuestion && testState.currentQuestionTime > 0) {
                        testState.questionTimers[testState.currentQuestion] = 
                            (testState.questionTimers[testState.currentQuestion] || 0) + testState.currentQuestionTime;
                    }
                }
                
                testState.currentQuestion = questionNumber;
                testState.skippedQuestionsMode = false;
                
                const questionContainer = document.createElement('div');
                questionContainer.className = 'single-question-container fade-in';
                
                const question = testState.questions[questionNumber - 1];
                
                if (!question) {
                    console.error('Вопрос не найден:', questionNumber);
                    alert('Ошибка: вопрос не найден. Пожалуйста, перезагрузите тест.');
                    return;
                }
                
                let sectionName = question.section || 'Общие вопросы';
                
                const questionText = question.text;
                const options = question.options;
                const correctAnswer = question.correctAnswer;
                const explanation = question.explanation || '';
                
                const progressPercent = (questionNumber / testState.totalQuestions) * 100;
                
                let optionsHTML = '';
                const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                
                options.forEach((option, index) => {
                    const optionValue = optionLetters[index];
                    const optionText = option;
                    const optionLetter = optionLetters[index];
                    
                    const isSelected = testState.answers[questionNumber] === optionValue;
                    const isBookmarked = testState.bookmarkedQuestions.includes(questionNumber);
                    const isCorrect = optionValue === correctAnswer;
                    const isLocked = testState.answeredLocked[questionNumber] === true;
                    
                    let optionClass = 'single-option';
                    if (isSelected) optionClass += ' selected';
                    if (isLocked) optionClass += ' locked';
                    
                    optionsHTML += `
                        <div class="${optionClass}" data-value="${optionValue}" data-correct="${isCorrect}" ${isLocked ? 'style="cursor: not-allowed;"' : ''}>
                            <span class="single-option-letter">${optionLetter}</span>
                            <span class="single-option-text">${optionText}</span>
                        </div>
                    `;
                });
                
                const isBookmarked = testState.bookmarkedQuestions.includes(questionNumber);
                const isLocked = testState.answeredLocked[questionNumber] === true;
                
                // Отображение времени на вопрос (если уже отвечали на него ранее)
                const timeSpent = testState.questionTimers[questionNumber] || 0;
                const timeInfo = timeSpent > 0 ? 
                    `<div class="question-time-info"><i class="fas fa-clock"></i> Ранее потрачено: ${timeSpent} сек</div>` : '';
                
                // Индикатор режима тренировки
                const trainingIndicator = testState.testMode === 'training' ? 
                    `<div class="training-mode-indicator"><i class="fas fa-graduation-cap"></i> Режим тренировки</div>` : '';
                
                // Подсказка для режима тренировки
                const trainingHint = testState.testMode === 'training' ? 
                    `<div class="training-mode-hint">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Режим тренировки:</strong> После выбора ответа вы увидите правильный вариант и сможете перейти к следующему вопросу. Результаты не сохраняются.
                    </div>` : '';
                
                // История ответов для режима тренировки
                let trainingHistoryInfo = '';
                if (testState.testMode === 'training' && testState.trainingHistory[questionNumber]) {
                    const history = testState.trainingHistory[questionNumber];
                    trainingHistoryInfo = `
                        <div class="training-mode-hint" style="background-color: #e8f4fc;">
                            <i class="fas fa-history"></i>
                            <strong>Ваш предыдущий ответ:</strong> ${history.userAnswer} - 
                            ${history.isCorrect ? '<span style="color: #27ae60;">Правильно</span>' : '<span style="color: #e74c3c;">Неправильно</span>'}
                            ${history.explanation ? `<br><strong>Объяснение:</strong> ${history.explanation}` : ''}
                        </div>
                    `;
                }
                
                questionContainer.innerHTML = `
                    ${trainingIndicator}
                    
                    <div class="question-progress">
                        <div class="question-number-large">${questionNumber}</div>
                        <div class="question-progress-bar">
                            <div class="question-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="question-progress-text">${questionNumber} из ${testState.totalQuestions}</div>
                    </div>
                    
                    <div class="section-indicator">
                        ${sectionName}
                        ${question.difficulty ? `<span class="difficulty-indicator difficulty-${question.difficulty.toLowerCase()}">${question.difficulty}</span>` : ''}
                    </div>
                    
                    ${timeInfo}
                    ${trainingHint}
                    ${trainingHistoryInfo}
                    
                    <div class="single-question-text">${questionText}</div>
                    
                    <div class="single-options">
                        ${optionsHTML}
                    </div>
                    
                    <!-- Контейнер для отображения результата -->
                    <div id="answer-feedback-${questionNumber}" class="answer-feedback" style="display: none;"></div>
                    
                    <i class="fas fa-bookmark question-bookmark ${isBookmarked ? 'active' : ''}" id="bookmark-${questionNumber}"></i>
                    
                    <div class="single-question-controls">
                        <div class="single-question-navigation">
                            <button class="btn btn-primary" id="prev-question-btn" ${questionNumber === 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left"></i> Предыдущий
                            </button>
                            
                            ${testState.testMode === 'training' ? 
                                `<button class="btn btn-info" id="show-answer-btn">
                                    <i class="fas fa-eye"></i> Показать ответ
                                </button>` : ''
                            }
                            
                            <button class="btn btn-warning" id="finish-test-early-btn" style="background-color: #ff9800;">
                                <i class="fas fa-flag-checkered"></i> Завершить тест
                            </button>
                            
                            ${questionNumber === testState.totalQuestions ? 
                                `<button class="btn btn-success" id="finish-test-btn">
                                    <i class="fas fa-check-circle"></i> Завершить тест
                                </button>` :
                                `<button class="btn btn-primary" id="next-question-btn">
                                    Следующий <i class="fas fa-arrow-right"></i>
                                </button>`
                            }
                        </div>
                    </div>
                `;
                
                elements.singleQuestionDisplay.innerHTML = '';
                elements.singleQuestionDisplay.appendChild(questionContainer);
                questionContainer.style.display = 'block';
                
                // Запускаем таймер для отслеживания времени на текущий вопрос
                this.startQuestionTimer();
                
                // Добавляем обработчики событий
                document.getElementById('prev-question-btn').addEventListener('click', () => {
                    if (questionNumber > 1) {
                        this.showQuestion(questionNumber - 1);
                    }
                });
                
                if (questionNumber < testState.totalQuestions) {
                    document.getElementById('next-question-btn').addEventListener('click', () => {
                        this.showQuestion(questionNumber + 1);
                    });
                } else {
                    document.getElementById('finish-test-btn').addEventListener('click', () => this.handleCheckTest());
                }
                
                document.getElementById('finish-test-early-btn').addEventListener('click', () => this.handleCheckTest());
                
                // Кнопка показа ответа для тренировочного режима
                if (testState.testMode === 'training') {
                    document.getElementById('show-answer-btn').addEventListener('click', () => {
                        this.showTrainingAnswer(questionNumber, correctAnswer, explanation);
                    });
                }
                
                document.getElementById(`bookmark-${questionNumber}`).addEventListener('click', () => {
                    this.toggleBookmark(questionNumber);
                });
                
                // Обработчик выбора варианта ответа
                questionContainer.querySelectorAll('.single-option').forEach(option => {
                    option.addEventListener('click', () => {
                        // Если ответ на этот вопрос уже заблокирован, не обрабатываем клик
                        if (testState.answeredLocked[questionNumber]) {
                            return;
                        }
                        
                        // Останавливаем предыдущий таймер автоматического перехода
                        if (testState.autoTransitionTimer) {
                            clearTimeout(testState.autoTransitionTimer);
                            testState.autoTransitionTimer = null;
                        }
                        
                        // Снимаем выделение со всех вариантов
                        questionContainer.querySelectorAll('.single-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // Выделяем выбранный вариант
                        option.classList.add('selected');
                        
                        // Сохраняем ответ в состояние теста
                        const selectedValue = option.getAttribute('data-value');
                        testState.answers[questionNumber] = selectedValue;
                        
                        // В режиме тренировки сохраняем историю ответов
                        if (testState.testMode === 'training') {
                            testState.trainingHistory[questionNumber] = {
                                userAnswer: selectedValue,
                                correctAnswer: correctAnswer,
                                isCorrect: selectedValue === correctAnswer,
                                explanation: explanation
                            };
                        }
                        
                        // Блокируем возможность изменить ответ в экзаменационном режиме
                        if (testState.testMode === 'exam') {
                            testState.answeredLocked[questionNumber] = true;
                            
                            // Помечаем все варианты как заблокированные
                            questionContainer.querySelectorAll('.single-option').forEach(opt => {
                                opt.classList.add('locked');
                                opt.style.cursor = 'not-allowed';
                            });
                            
                            // Проверяем ответ и показываем результат
                            this.checkAndShowAnswerFeedback(questionNumber, selectedValue, correctAnswer, explanation);
                            
                            // Запускаем таймер для автоматического перехода через 10 секунд
                            testState.autoTransitionTimer = setTimeout(() => {
                                if (questionNumber < testState.totalQuestions) {
                                    this.showQuestion(questionNumber + 1);
                                }
                            }, 10000);
                        } else {
                            // В режиме тренировки сразу показываем результат
                            this.showTrainingAnswer(questionNumber, correctAnswer, explanation);
                        }
                        
                        // Обновляем кнопки навигации
                        this.updateJumpButtons();
                    });
                });
                
                // Если уже был дан ответ на этот вопрос, показываем результат и блокируем
                if (testState.answers[questionNumber]) {
                    if (testState.testMode === 'exam') {
                        this.checkAndShowAnswerFeedback(questionNumber, testState.answers[questionNumber], correctAnswer, explanation);
                        // Помечаем все варианты как заблокированные
                        questionContainer.querySelectorAll('.single-option').forEach(opt => {
                            opt.classList.add('locked');
                            opt.style.cursor = 'not-allowed';
                        });
                    } else {
                        // В режиме тренировки показываем историю
                        const history = testState.trainingHistory[questionNumber];
                        if (history) {
                            this.showTrainingAnswer(questionNumber, correctAnswer, explanation);
                        }
                    }
                }
                
                this.updateJumpButtons();
                this.updateBookmarksList();
                
                setTimeout(() => {
                    const questionElement = document.querySelector('.single-question-container');
                    if (questionElement) {
                        questionElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            }
            
            showTrainingAnswer(questionNumber, correctAnswer, explanation) {
                const questionContainer = document.querySelector('.single-question-container');
                if (!questionContainer) return;
                
                const feedbackElement = document.getElementById(`answer-feedback-${questionNumber}`);
                if (!feedbackElement) return;
                
                // Очищаем предыдущие классы
                feedbackElement.className = 'answer-feedback';
                feedbackElement.style.display = 'none';
                
                // Снимаем предыдущие стили с вариантов ответов
                questionContainer.querySelectorAll('.single-option').forEach(option => {
                    option.classList.remove('correct', 'incorrect', 'show-correct-answer', 'highlight-incorrect');
                });
                
                // Получаем выбранный ответ
                const selectedAnswer = testState.answers[questionNumber];
                
                // Подсвечиваем правильные и неправильные ответы
                questionContainer.querySelectorAll('.single-option').forEach(option => {
                    const optionValue = option.getAttribute('data-value');
                    const isCorrect = optionValue === correctAnswer;
                    const isSelected = optionValue === selectedAnswer;
                    
                    if (isCorrect) {
                        option.classList.add('correct', 'show-correct-answer');
                    } else if (isSelected && !isCorrect) {
                        option.classList.add('incorrect', 'highlight-incorrect');
                    }
                });
                
                // Показываем обратную связь
                const isCorrect = selectedAnswer === correctAnswer;
                
                if (isCorrect) {
                    feedbackElement.innerHTML = `
                        <i class="fas fa-check-circle"></i> Правильно! Вы выбрали правильный ответ.
                        ${explanation ? `<div style="margin-top: 10px; padding: 10px; background-color: #e7f7ef; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <strong><i class="fas fa-lightbulb"></i> Объяснение:</strong> ${explanation}
                        </div>` : ''}
                        <div style="margin-top: 15px; font-size: 0.9rem; color: #27ae60;">
                            <i class="fas fa-arrow-right"></i> Вы можете перейти к следующему вопросу
                        </div>
                    `;
                    feedbackElement.classList.add('correct');
                } else {
                    feedbackElement.innerHTML = `
                        <i class="fas fa-times-circle"></i> Неправильно!
                        <div class="correct-answer-indicator">
                            <i class="fas fa-lightbulb"></i> Правильный ответ: <strong>${correctAnswer}</strong>
                        </div>
                        ${explanation ? `<div style="margin-top: 10px; padding: 10px; background-color: #fdeaea; border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <strong><i class="fas fa-lightbulb"></i> Объяснение:</strong> ${explanation}
                        </div>` : ''}
                        <div style="margin-top: 15px; font-size: 0.9rem; color: #e74c3c;">
                            <i class="fas fa-arrow-right"></i> Изучите объяснение и переходите к следующему вопросу
                        </div>
                    `;
                    feedbackElement.classList.add('incorrect');
                }
                
                feedbackElement.style.display = 'block';
                
                // Прячем кнопку "Показать ответ"
                const showAnswerBtn = document.getElementById('show-answer-btn');
                if (showAnswerBtn) {
                    showAnswerBtn.style.display = 'none';
                }
            }
            
            checkAndShowAnswerFeedback(questionNumber, selectedAnswer, correctAnswer, explanation) {
                const questionContainer = document.querySelector('.single-question-container');
                if (!questionContainer) return;
                
                const feedbackElement = document.getElementById(`answer-feedback-${questionNumber}`);
                if (!feedbackElement) return;
                
                // Очищаем предыдущие классы
                feedbackElement.className = 'answer-feedback';
                feedbackElement.style.display = 'none';
                
                // Снимаем предыдущие стили с вариантов ответов
                questionContainer.querySelectorAll('.single-option').forEach(option => {
                    option.classList.remove('correct', 'incorrect', 'show-correct-answer', 'highlight-incorrect');
                });
                
                if (!selectedAnswer) return;
                
                // Проверяем правильность ответа
                const isCorrect = selectedAnswer === correctAnswer;
                
                if (isCorrect) {
                    // Правильный ответ - подсвечиваем зеленым
                    const selectedOption = questionContainer.querySelector(`.single-option[data-value="${selectedAnswer}"]`);
                    if (selectedOption) {
                        selectedOption.classList.add('correct', 'show-correct-answer');
                        
                        feedbackElement.innerHTML = `
                            <i class="fas fa-check-circle"></i> Правильно! Вы выбрали правильный ответ.
                            ${explanation ? `<div style="margin-top: 10px; padding: 10px; background-color: #e7f7ef; border-radius: 8px; border-left: 4px solid #27ae60;">
                                <strong><i class="fas fa-lightbulb"></i> Объяснение:</strong> ${explanation}
                            </div>` : ''}
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #27ae60;">
                                <i class="fas fa-clock"></i> Ответ зафиксирован. Автоматический переход через 10 секунд...
                            </div>
                        `;
                        feedbackElement.classList.add('correct');
                        feedbackElement.style.display = 'block';
                    }
                } else {
                    // Неправильный ответ - подсвечиваем красным и показываем правильный ответ
                    const selectedOption = questionContainer.querySelector(`.single-option[data-value="${selectedAnswer}"]`);
                    const correctOption = questionContainer.querySelector(`.single-option[data-value="${correctAnswer}"]`);
                    
                    if (selectedOption) {
                        selectedOption.classList.add('incorrect', 'highlight-incorrect');
                    }
                    
                    if (correctOption) {
                        correctOption.classList.add('correct', 'show-correct-answer');
                    }
                    
                    const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                    const correctAnswerText = correctOption ? correctOption.querySelector('.single-option-text').textContent : '';
                    
                    feedbackElement.innerHTML = `
                        <i class="fas fa-times-circle"></i> Неправильно!<br>
                        <div class="correct-answer-indicator">
                            <i class="fas fa-lightbulb"></i> Правильный ответ: <strong>${correctAnswer} (${correctAnswerText})</strong>
                        </div>
                        ${explanation ? `<div style="margin-top: 10px; padding: 10px; background-color: #fdeaea; border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <strong><i class="fas fa-lightbulb"></i> Объяснение:</strong> ${explanation}
                        </div>` : ''}
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #e74c3c;">
                            <i class="fas fa-clock"></i> Ответ зафиксирован. Автоматический переход через 10 секунд...
                        </div>
                    `;
                    feedbackElement.classList.add('incorrect');
                    feedbackElement.style.display = 'block';
                }
            }
            
            toggleBookmark(questionNumber) {
                const index = testState.bookmarkedQuestions.indexOf(questionNumber);
                const bookmarkIcon = document.getElementById(`bookmark-${questionNumber}`);
                
                if (index === -1) {
                    testState.bookmarkedQuestions.push(questionNumber);
                    if (bookmarkIcon) {
                        bookmarkIcon.classList.add('active');
                    }
                } else {
                    testState.bookmarkedQuestions.splice(index, 1);
                    if (bookmarkIcon) {
                        bookmarkIcon.classList.remove('active');
                    }
                }
                
                this.updateBookmarksList();
            }
            
            updateJumpButtons() {
                elements.jumpDropdown.innerHTML = `
                    <div class="jump-title">Перейти к вопросу</div>
                `;
                
                if (testState.sections && testState.sections.length > 0) {
                    testState.sections.forEach((section, sectionIndex) => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'jump-section';
                        
                        const sectionTitle = document.createElement('div');
                        sectionTitle.className = 'jump-section-title';
                        sectionTitle.textContent = section.name;
                        
                        const questionsDiv = document.createElement('div');
                        questionsDiv.className = 'jump-questions';
                        questionsDiv.id = `jump-section-${sectionIndex}`;
                        
                        sectionDiv.appendChild(sectionTitle);
                        sectionDiv.appendChild(questionsDiv);
                        elements.jumpDropdown.appendChild(sectionDiv);
                    });
                    
                    const questionsWithoutSection = testState.questions.filter(q => !q.section);
                    if (questionsWithoutSection.length > 0) {
                        const defaultSectionDiv = document.createElement('div');
                        defaultSectionDiv.className = 'jump-section';
                        
                        const sectionTitle = document.createElement('div');
                        sectionTitle.className = 'jump-section-title';
                        sectionTitle.textContent = 'Общие вопросы';
                        
                        const questionsDiv = document.createElement('div');
                        questionsDiv.className = 'jump-questions';
                        questionsDiv.id = 'jump-section-default';
                        
                        defaultSectionDiv.appendChild(sectionTitle);
                        defaultSectionDiv.appendChild(questionsDiv);
                        elements.jumpDropdown.appendChild(defaultSectionDiv);
                    }
                } else {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'jump-section';
                    
                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'jump-section-title';
                    sectionTitle.textContent = 'Все вопросы';
                    
                    const questionsDiv = document.createElement('div');
                    questionsDiv.className = 'jump-questions';
                    questionsDiv.id = 'jump-all-questions';
                    
                    sectionDiv.appendChild(sectionTitle);
                    sectionDiv.appendChild(questionsDiv);
                    elements.jumpDropdown.appendChild(sectionDiv);
                }
                
                for (let i = 1; i <= testState.totalQuestions; i++) {
                    const question = testState.questions[i - 1];
                    let containerId = '';
                    
                    if (testState.sections && testState.sections.length > 0) {
                        if (question.section) {
                            const sectionIndex = testState.sections.findIndex(s => s.name === question.section);
                            if (sectionIndex !== -1) {
                                containerId = `jump-section-${sectionIndex}`;
                            } else {
                                containerId = 'jump-section-default';
                            }
                        } else {
                            containerId = 'jump-section-default';
                        }
                    } else {
                        containerId = 'jump-all-questions';
                    }
                    
                    const container = document.getElementById(containerId);
                    if (!container) continue;
                    
                    const button = document.createElement('button');
                    button.className = 'jump-question-btn';
                    button.textContent = i;
                    
                    if (i === testState.currentQuestion) {
                        button.classList.add('current');
                    } else if (testState.answers[i]) {
                        // Проверяем, правильный ли ответ
                        const userAnswer = testState.answers[i];
                        const correctAnswer = question.correctAnswer;
                        if (userAnswer === correctAnswer) {
                            button.classList.add('answered');
                        } else {
                            button.classList.add('skipped');
                        }
                    } else if (testState.skippedQuestions.includes(i)) {
                        button.classList.add('skipped');
                    }
                    
                    button.addEventListener('click', () => {
                        this.showQuestion(i);
                        elements.jumpDropdown.classList.remove('active');
                    });
                    
                    container.appendChild(button);
                }
            }
            
            updateBookmarksList() {
                const bookmarksList = elements.bookmarksList;
                bookmarksList.innerHTML = '';
                
                if (testState.bookmarkedQuestions.length === 0) {
                    elements.noBookmarks.style.display = 'block';
                    return;
                }
                
                elements.noBookmarks.style.display = 'none';
                
                const sortedBookmarks = [...testState.bookmarkedQuestions].sort((a, b) => a - b);
                
                sortedBookmarks.forEach(questionNumber => {
                    const button = document.createElement('button');
                    button.className = 'jump-question-btn';
                    button.textContent = questionNumber;
                    
                    if (questionNumber === testState.currentQuestion) {
                        button.classList.add('current');
                    } else if (testState.answers[questionNumber]) {
                        button.classList.add('answered');
                    }
                    
                    button.addEventListener('click', () => {
                        this.showQuestion(questionNumber);
                        elements.bookmarksDropdown.classList.remove('active');
                    });
                    
                    bookmarksList.appendChild(button);
                });
            }
            
            toggleJumpDropdown() {
                elements.jumpDropdown.classList.toggle('active');
                if (elements.jumpDropdown.classList.contains('active')) {
                    this.updateJumpButtons();
                }
            }
            
            toggleBookmarksDropdown() {
                elements.bookmarksDropdown.classList.toggle('active');
                if (elements.bookmarksDropdown.classList.contains('active')) {
                    this.updateBookmarksList();
                }
            }
            
            toggleExtendedStats() {
                const extendedStats = elements.extendedStats;
                if (extendedStats.style.display === 'none' || extendedStats.style.display === '') {
                    extendedStats.style.display = 'block';
                    elements.toggleStatsBtn.innerHTML = '<i class="fas fa-chart-line"></i> Скрыть статистику';
                } else {
                    extendedStats.style.display = 'none';
                    elements.toggleStatsBtn.innerHTML = '<i class="fas fa-chart-line"></i> Подробная статистика';
                }
            }
            
            showPasswordModal() {
                elements.passwordError.style.display = 'none';
                elements.passwordInput.value = '';
                elements.passwordModal.style.display = 'flex';
                elements.passwordInput.focus();
            }
            
            hidePasswordModal() {
                elements.passwordModal.style.display = 'none';
            }
            
            handleConfirmPassword() {
                const enteredPassword = elements.passwordInput.value;
                
                if (enteredPassword === userPasswords.admin) {
                    this.hidePasswordModal();
                    this.resetTest();
                } else {
                    elements.passwordError.style.display = 'block';
                    elements.passwordInput.value = '';
                    elements.passwordInput.focus();
                }
            }
            
            getUnansweredQuestions() {
                const unansweredQuestions = [];
                
                for (let i = 1; i <= testState.totalQuestions; i++) {
                    if (!testState.answers[i] && !testState.skippedQuestions.includes(i)) {
                        const question = testState.questions[i - 1];
                        
                        let section = question.section || 'Общие вопросы';
                        
                        const shortText = question.text.length > 100 ? 
                            question.text.substring(0, 100) + '...' : question.text;
                        
                        unansweredQuestions.push({
                            number: i,
                            text: shortText,
                            fullText: question.text,
                            section: section
                        });
                    }
                }
                
                return unansweredQuestions;
            }
            
            showUnansweredModal(unansweredQuestions) {
                elements.unansweredList.innerHTML = '';
                
                if (unansweredQuestions.length === 0) {
                    elements.unansweredList.innerHTML = '<p style="text-align: center; color: #666;">Все вопросы отвечены</p>';
                    return;
                }
                
                unansweredQuestions.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'unanswered-item';
                    itemElement.innerHTML = `
                        <span class="unanswered-item-number">${item.number}</span>
                        <strong>${item.section}</strong><br>
                        ${item.text}
                    `;
                    
                    itemElement.addEventListener('click', () => {
                        this.hideUnansweredModal();
                        
                        setTimeout(() => {
                            this.showQuestion(item.number);
                        }, 300);
                    });
                    
                    elements.unansweredList.appendChild(itemElement);
                });
                
                elements.unansweredModal.style.display = 'flex';
            }
            
            hideUnansweredModal() {
                elements.unansweredModal.style.display = 'none';
            }
            
            handleAnswerUnanswered() {
                this.hideUnansweredModal();
            }
            
            handleSkipUnanswered() {
                const currentUnanswered = this.getUnansweredQuestions();
                
                currentUnanswered.forEach(item => {
                    if (!testState.skippedQuestions.includes(item.number)) {
                        testState.skippedQuestions.push(item.number);
                    }
                });
                
                this.hideUnansweredModal();
                
                clearInterval(testState.timer);
                
                testState.endTime = new Date();
                
                this.checkAnswers();
                this.persistTestResult();
                this.showResults();
            }
            
            handleCheckTest() {
                // В режиме тренировки показываем результаты без проверки пропущенных вопросов
                if (testState.testMode === 'training') {
                    clearInterval(testState.timer);
                    
                    testState.endTime = new Date();
                    
                    this.checkAnswers();
                    this.persistTestResult();
                    this.showResults();
                    return;
                }
                
                const unansweredQuestions = this.getUnansweredQuestions();
                
                if (unansweredQuestions.length > 0) {
                    this.showSkippedQuestionsPage(unansweredQuestions);
                    return;
                }
                
                // Останавливаем таймер для текущего вопроса
                if (testState.questionTimer) {
                    clearInterval(testState.questionTimer);
                    
                    // Сохраняем время для текущего вопроса
                    if (testState.currentQuestion && testState.currentQuestionTime > 0) {
                        testState.questionTimers[testState.currentQuestion] = 
                            (testState.questionTimers[testState.currentQuestion] || 0) + testState.currentQuestionTime;
                    }
                }
                
                // Останавливаем таймер автоматического перехода
                if (testState.autoTransitionTimer) {
                    clearTimeout(testState.autoTransitionTimer);
                    testState.autoTransitionTimer = null;
                }
                
                clearInterval(testState.timer);
                
                testState.endTime = new Date();
                
                this.checkAnswers();
                this.persistTestResult();
                this.showResults();
            }
            
            showSkippedQuestionsPage(unansweredQuestions) {
                if (unansweredQuestions.length === 0) {
                    this.handleCheckTest();
                    return;
                }
                
                testState.skippedQuestionsList = [...unansweredQuestions];
                
                const skippedPageHTML = `
                    <div class="skipped-questions-container fade-in">
                        <div class="section-title">
                            Пропущенные вопросы
                        </div>
                        
                        <p style="font-size: 1.15rem; margin-bottom: 35px; line-height: 1.7;">
                            Вы пропустили <strong style="color: #e74c3c;">${unansweredQuestions.length}</strong> вопрос(ов). 
                            Вы можете ответить на них сейчас или пропустить (они будут засчитаны как неправильные).
                        </p>
                        
                        <div class="skipped-questions-list">
                            ${unansweredQuestions.map((q, index) => `
                                <div class="skipped-question-item" data-question="${q.number}">
                                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                        <span class="skipped-question-number">${q.number}</span>
                                        <strong>${q.section}</strong>
                                    </div>
                                    <div style="color: #333; font-size: 1rem; line-height: 1.6;">
                                        ${q.fullText.length > 150 ? q.fullText.substring(0, 150) + '...' : q.fullText}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="skipped-actions">
                            <button class="btn btn-success" id="answer-all-skipped-btn">
                                <i class="fas fa-edit"></i> Ответить на все вопросы
                            </button>
                            <button class="btn btn-primary" id="skip-all-skipped-btn">
                                <i class="fas fa-forward"></i> Перейти к результатам
                            </button>
                            <button class="btn btn-warning" id="review-skipped-btn">
                                <i class="fas fa-list-check"></i> Просмотреть по очереди
                            </button>
                        </div>
                    </div>
                `;
                
                elements.singleQuestionDisplay.innerHTML = skippedPageHTML;
                
                // Останавливаем таймер для текущего вопроса
                if (testState.questionTimer) {
                    clearInterval(testState.questionTimer);
                }
                
                // Останавливаем таймер автоматического перехода
                if (testState.autoTransitionTimer) {
                    clearTimeout(testState.autoTransitionTimer);
                    testState.autoTransitionTimer = null;
                }
                
                // ИСПРАВЛЕНИЕ: Правильная привязка обработчика клика на пропущенный вопрос
                const skippedItems = document.querySelectorAll('.skipped-question-item');
                skippedItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const questionNum = parseInt(item.getAttribute('data-question'));
                        this.showQuestion(questionNum);
                    });
                });
                
                document.getElementById('answer-all-skipped-btn').addEventListener('click', () => {
                    if (unansweredQuestions.length > 0) {
                        this.showQuestion(unansweredQuestions[0].number);
                    }
                });
                
                document.getElementById('skip-all-skipped-btn').addEventListener('click', () => {
                    unansweredQuestions.forEach(q => {
                        if (!testState.skippedQuestions.includes(q.number)) {
                            testState.skippedQuestions.push(q.number);
                        }
                    });
                    
                    clearInterval(testState.timer);
                    
                    testState.endTime = new Date();
                    
                    this.checkAnswers();
                    this.persistTestResult();
                    this.showResults();
                });
                
                document.getElementById('review-skipped-btn').addEventListener('click', () => {
                    if (unansweredQuestions.length > 0) {
                        this.startSkippedQuestionsReview(unansweredQuestions);
                    }
                });
            }
            
            startSkippedQuestionsReview(skippedQuestions) {
                if (skippedQuestions.length === 0) return;
                
                const sortedQuestions = [...skippedQuestions].sort((a, b) => a.number - b.number);
                testState.skippedQuestionsMode = true;
                testState.skippedQuestionsList = sortedQuestions;
                testState.currentSkippedIndex = 0;
                
                this.showCurrentSkippedQuestion();
            }
            
            showCurrentSkippedQuestion() {
                if (testState.currentSkippedIndex < testState.skippedQuestionsList.length) {
                    const question = testState.skippedQuestionsList[testState.currentSkippedIndex];
                    this.showSkippedQuestionForReview(question, testState.currentSkippedIndex + 1, testState.skippedQuestionsList.length);
                } else {
                    this.showSkippedQuestionsPage(this.getUnansweredQuestions());
                }
            }
            
            showSkippedQuestionForReview(question, currentIndex, totalCount) {
                const questionNumber = question.number;
                
                const questionData = testState.questions[questionNumber - 1];
                if (!questionData) return;
                
                const questionText = questionData.text;
                const options = questionData.options;
                const correctAnswer = questionData.correctAnswer;
                
                let sectionName = questionData.section || 'Общие вопросы';
                
                let optionsHTML = '';
                const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                
                options.forEach((option, index) => {
                    const optionValue = optionLetters[index];
                    const optionText = option;
                    const optionLetter = optionLetters[index];
                    const isCorrect = optionValue === correctAnswer;
                    
                    const isSelected = testState.answers[questionNumber] === optionValue;
                    const isLocked = testState.answeredLocked[questionNumber] === true;
                    
                    let optionClass = 'single-option';
                    if (isSelected) optionClass += ' selected';
                    if (isCorrect) optionClass += ' correct';
                    else if (isSelected) optionClass += ' incorrect';
                    if (isLocked) optionClass += ' locked';
                    
                    optionsHTML += `
                        <div class="${optionClass}" data-value="${optionValue}" ${isLocked ? 'style="cursor: not-allowed;"' : ''}>
                            <span class="single-option-letter">${optionLetter}</span>
                            <span class="single-option-text">${optionText}</span>
                        </div>
                    `;
                });
                
                const reviewQuestionHTML = `
                    <div class="single-question-container fade-in">
                        <div class="question-progress">
                            <div class="question-number-large">${questionNumber}</div>
                            <div class="question-progress-bar">
                                <div class="question-progress-fill" style="width: ${(currentIndex / totalCount) * 100}%"></div>
                            </div>
                            <div class="question-progress-text">
                                Пропущенный вопрос ${currentIndex} из ${totalCount}
                            </div>
                        </div>
                        
                        <div class="section-indicator">
                            ${sectionName} (Пропущенный)
                        </div>
                        
                        <div class="single-question-text">${questionText}</div>
                        
                        <div class="single-options">
                            ${optionsHTML}
                        </div>
                        
                        <div class="single-question-controls">
                            <div class="single-question-navigation">
                                <button class="btn btn-primary" id="prev-skipped-btn" ${currentIndex === 1 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-left"></i> Предыдущий
                                </button>
                                
                                <button class="btn btn-success" id="mark-as-answered-btn">
                                    <i class="fas fa-check"></i> Ответил
                                </button>
                                
                                <button class="btn btn-warning" id="skip-this-btn">
                                    <i class="fas fa-forward"></i> Пропустить
                                </button>
                                
                                <button class="btn btn-primary" id="next-skipped-btn" ${currentIndex === totalCount ? 'disabled' : ''}>
                                    Следующий <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            
                            <button class="btn btn-info" id="back-to-skipped-list-btn">
                                <i class="fas fa-list"></i> Вернуться к списку
                            </button>
                        </div>
                    </div>
                `;
                
                elements.singleQuestionDisplay.innerHTML = reviewQuestionHTML;
                
                document.getElementById('prev-skipped-btn').addEventListener('click', () => {
                    if (testState.currentSkippedIndex > 0) {
                        testState.currentSkippedIndex--;
                        this.showCurrentSkippedQuestion();
                    }
                });
                
                document.getElementById('next-skipped-btn').addEventListener('click', () => {
                    if (testState.currentSkippedIndex < testState.skippedQuestionsList.length - 1) {
                        testState.currentSkippedIndex++;
                        this.showCurrentSkippedQuestion();
                    }
                });
                
                document.getElementById('mark-as-answered-btn').addEventListener('click', () => {
                    if (testState.currentSkippedIndex < testState.skippedQuestionsList.length - 1) {
                        testState.currentSkippedIndex++;
                        this.showCurrentSkippedQuestion();
                    } else {
                        this.showSkippedQuestionsPage(this.getUnansweredQuestions());
                    }
                });
                
                document.getElementById('skip-this-btn').addEventListener('click', () => {
                    if (!testState.skippedQuestions.includes(questionNumber)) {
                        testState.skippedQuestions.push(questionNumber);
                    }
                    
                    if (testState.currentSkippedIndex < testState.skippedQuestionsList.length - 1) {
                        testState.currentSkippedIndex++;
                        this.showCurrentSkippedQuestion();
                    } else {
                        this.showSkippedQuestionsPage(this.getUnansweredQuestions());
                    }
                });
                
                document.getElementById('back-to-skipped-list-btn').addEventListener('click', () => {
                    this.showSkippedQuestionsPage(this.getUnansweredQuestions());
                });
                
                // ИСПРАВЛЕНИЕ: Правильный обработчик для режима просмотра пропущенных вопросов
                document.querySelectorAll('.single-option').forEach(option => {
                    option.addEventListener('click', () => {
                        // Если ответ на этот вопрос уже заблокирован, не обрабатываем клик
                        if (testState.answeredLocked[questionNumber]) {
                            return;
                        }
                        
                        // Блокируем все варианты после выбора
                        testState.answeredLocked[questionNumber] = true;
                        
                        document.querySelectorAll('.single-option').forEach(opt => {
                            opt.classList.remove('selected');
                            opt.classList.add('locked');
                            opt.style.cursor = 'not-allowed';
                        });
                        
                        option.classList.add('selected');
                        
                        const selectedValue = option.getAttribute('data-value');
                        testState.answers[questionNumber] = selectedValue;
                        
                        // Сразу показываем результат
                        const isCorrect = selectedValue === correctAnswer;
                        
                        document.querySelectorAll('.single-option').forEach(opt => {
                            opt.classList.remove('correct', 'incorrect');
                            const optValue = opt.getAttribute('data-value');
                            if (optValue === correctAnswer) {
                                opt.classList.add('correct');
                            } else if (optValue === selectedValue && !isCorrect) {
                                opt.classList.add('incorrect');
                            }
                        });
                    });
                });
            }
            
            checkAnswers() {
                let correctCount = 0;
                let answeredCount = 0;
                let skippedCount = 0;
                let unansweredCount = 0;
                
                testState.questionResults = [];
                testState.sectionStats = {};
                testState.extendedStats = {
                    totalQuestions: testState.totalQuestions,
                    correctCount: 0,
                    incorrectCount: 0,
                    skippedCount: 0,
                    unansweredCount: 0,
                    percentage: 0,
                    averageTimePerQuestion: 0,
                    bestSection: '',
                    worstSection: ''
                };
                
                for (let i = 1; i <= testState.totalQuestions; i++) {
                    const question = testState.questions[i - 1];
                    if (!question) continue;
                    
                    const correctAnswer = question.correctAnswer;
                    const userAnswer = testState.answers[i];
                    const isSkipped = testState.skippedQuestions.includes(i);
                    const section = question.section || 'Общие вопросы';
                    
                    if (!testState.sectionStats[section]) {
                        testState.sectionStats[section] = {
                            total: 0,
                            correct: 0,
                            incorrect: 0,
                            skipped: 0,
                            unanswered: 0,
                            percentage: 0
                        };
                    }
                    
                    testState.sectionStats[section].total++;
                    
                    const questionResult = {
                        number: i,
                        questionText: question.text,
                        options: question.options,
                        correctAnswer: correctAnswer,
                        userAnswer: userAnswer,
                        isSkipped: isSkipped,
                        isCorrect: false,
                        section: section,
                        difficulty: question.difficulty || 'Средний',
                        explanation: question.explanation || '',
                        // Время на вопрос
                        timeSpent: testState.questionTimers[i] || 0
                    };
                    
                    if (isSkipped) {
                        answeredCount++;
                        skippedCount++;
                        testState.sectionStats[section].skipped++;
                        questionResult.isCorrect = false;
                        questionResult.status = 'skipped';
                    } 
                    else if (userAnswer) {
                        answeredCount++;
                        
                        if (userAnswer === correctAnswer) {
                            correctCount++;
                            testState.sectionStats[section].correct++;
                            questionResult.isCorrect = true;
                            questionResult.status = 'correct';
                        } else {
                            testState.sectionStats[section].incorrect++;
                            questionResult.isCorrect = false;
                            questionResult.status = 'incorrect';
                        }
                    }
                    else {
                        unansweredCount++;
                        testState.sectionStats[section].unanswered++;
                        questionResult.isCorrect = false;
                        questionResult.status = 'unanswered';
                    }
                    
                    testState.questionResults.push(questionResult);
                }
                
                for (const section in testState.sectionStats) {
                    const stats = testState.sectionStats[section];
                    stats.percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                }
                
                testState.extendedStats.correctCount = correctCount;
                testState.extendedStats.incorrectCount = answeredCount - correctCount;
                testState.extendedStats.skippedCount = skippedCount;
                testState.extendedStats.unansweredCount = unansweredCount;
                testState.extendedStats.percentage = testState.totalQuestions > 0 ? Math.round((correctCount / testState.totalQuestions) * 100) : 0;
                
                let bestSection = '';
                let bestPercentage = 0;
                let worstSection = '';
                let worstPercentage = 100;
                
                for (const section in testState.sectionStats) {
                    const stats = testState.sectionStats[section];
                    if (stats.percentage > bestPercentage) {
                        bestPercentage = stats.percentage;
                        bestSection = section;
                    }
                    if (stats.percentage < worstPercentage) {
                        worstPercentage = stats.percentage;
                        worstSection = section;
                    }
                }
                
                testState.extendedStats.bestSection = bestSection;
                testState.extendedStats.worstSection = worstSection;
                
                // Расчет среднего времени на вопрос
                let totalTimeSpent = 0;
                let questionsWithTime = 0;
                
                for (let i = 1; i <= testState.totalQuestions; i++) {
                    if (testState.questionTimers[i]) {
                        totalTimeSpent += testState.questionTimers[i];
                        questionsWithTime++;
                    }
                }
                
                if (questionsWithTime > 0) {
                    testState.extendedStats.averageTimePerQuestion = Math.round(totalTimeSpent / questionsWithTime);
                } else {
                    testState.extendedStats.averageTimePerQuestion = 0;
                }
                
                if (testState.startTime && testState.endTime) {
                    const timeDiff = testState.endTime - testState.startTime;
                    const totalSeconds = Math.floor(timeDiff / 1000);
                    // Используем реальное среднее время, если оно есть
                    if (testState.extendedStats.averageTimePerQuestion === 0) {
                        testState.extendedStats.averageTimePerQuestion = testState.totalQuestions > 0 ? Math.round(totalSeconds / testState.totalQuestions) : 0;
                    }
                }
                
                return { correctCount, answeredCount, skippedCount, unansweredCount };
            }
            
            calculateTestTime() {
                if (!testState.startTime || !testState.endTime) {
                    return "00:00";
                }
                
                const timeDiff = testState.endTime - testState.startTime;
                const totalSeconds = Math.floor(timeDiff / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            

            // Сохраняем результат теста в localStorage (для отображения в админ-панели)
            persistTestResult() {
                try {
                    const saved = localStorage.getItem('testResults');
                    let reports = saved ? JSON.parse(saved) : [];
                    if (!Array.isArray(reports)) reports = [];

                    // Итоги (checkAnswers уже считает correct/incorrect)
                    const results = this.checkAnswers();
                    const percentage = testState.totalQuestions > 0
                        ? Math.round((results.correctCount / testState.totalQuestions) * 100)
                        : 0;
                    const duration = this.calculateTestTime();

                    const now = new Date();
                    const testDate = now.toISOString().slice(0, 10); // YYYY-MM-DD
                    const testTime = now.toTimeString().slice(0, 5); // HH:MM

                    // Детализация по всем вопросам для админ-режима
                    const detailedAnswers = [];
                    const questions = Array.isArray(testState.questions) ? testState.questions : [];
                    for (let i = 0; i < questions.length; i++) {
                        const qNumber = i + 1;
                        const q = questions[i] || {};
                        const selected = testState.answers ? testState.answers[qNumber] : undefined;
                        const correct = (q.correctAnswer || q.correct || q.answer || '').toString().trim().toUpperCase();
                        const selectedNorm = (selected || '').toString().trim().toUpperCase();

                        const options = Array.isArray(q.options) ? q.options : (Array.isArray(q.answers) ? q.answers : []);
                        const optionLetters = ['A','B','C','D','E','F'];

                        const correctIndex = correct ? optionLetters.indexOf(correct) : -1;
                        const selectedIndex = selectedNorm ? optionLetters.indexOf(selectedNorm) : -1;

                        detailedAnswers.push({
                            number: qNumber,
                            section: q.section || q.topic || q.block || 'Без раздела',
                            text: q.text || q.question || '',
                            options: options.map((t, idx) => ({
                                letter: optionLetters[idx] || String(idx + 1),
                                text: (t ?? '').toString()
                            })),
                            correctAnswer: correct || '',
                            selectedAnswer: selectedNorm || '',
                            isCorrect: !!(selectedNorm && correct && selectedNorm === correct),
                            explanation: q.explanation || q.comment || ''
                        });
                    }

                    const report = {
                        id: String(Date.now()),
                        userName: (testState.userName || 'Не указано').trim(),
                        userPosition: (testState.userPosition || 'Не указана').trim(),
                        userDepartment: (testState.userDepartment || 'Не указано').trim(),
                        testTitle: (testState.testTitle || 'Тест').trim(),
                        testDate,
                        testTime,
                        score: percentage,
                        correctAnswers: results.correctCount,
                        totalQuestions: testState.totalQuestions,
                        testDuration: duration,
                        status: 'Завершен',
                        details: {
                            answers: testState.answers || {},
                            answersDetailed: detailedAnswers,
                            sections: testState.sections || []
                        }
                    };

                    reports.push(report);
                    localStorage.setItem('testResults', JSON.stringify(reports));

                    // Отправка результата на сервер (для просмотра в админке с любого устройства)
                    try {
                        fetch('/api/results', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(report)
                        }).catch(()=>{});
                    } catch (e) {}

                } catch (error) {
                    console.error('Ошибка сохранения отчета теста:', error);
                }
            }

showResults() {
                const results = this.checkAnswers();
                const percentage = testState.totalQuestions > 0 ? Math.round((results.correctCount / testState.totalQuestions) * 100) : 0;
                const testTime = this.calculateTestTime();
                
                elements.resultUserName.textContent = testState.userName;
                if (testState.userPosition) {
                    elements.resultUserPosition.textContent = testState.userPosition;
                } else {
                    elements.resultUserPosition.textContent = 'Не указана';
                }
                if (testState.userDepartment) {
                    elements.resultUserDepartment.textContent = testState.userDepartment;
                } else {
                    elements.resultUserDepartment.textContent = 'Не указано';
                }
                
                elements.resultTestDate.textContent = new Date().toLocaleDateString('ru-RU');
                elements.resultTestTime.textContent = new Date().toLocaleTimeString('ru-RU');
                
                // Добавляем информацию о настройках теста
                const settingsText = `Время: ${testState.testSettings.timeLimit} мин, ` +
                                    `Порядок: ${testState.testSettings.shuffleEnabled ? 'случайный' : 'стандартный'}, ` +
                                    `Режим: ${testState.testMode === 'training' ? 'тренировочный' : 'экзаменационный'}`;
                elements.resultTestSettings.textContent = settingsText;
                
                elements.finalScore.textContent = `${percentage}%`;
                elements.correctCount.textContent = results.correctCount;
                elements.incorrectCount.textContent = results.answeredCount - results.correctCount;
                elements.totalAnswered.textContent = `${results.answeredCount}/${testState.totalQuestions}`;
                elements.testTime.textContent = testTime;
                
                elements.scoreCircle.style.background = 
                    `conic-gradient(#27ae60 0% ${percentage}%, #e6e9f0 ${percentage}% 100%)`;
                
                let message = '';
                if (testState.testMode === 'training') {
                    message = 'Тренировочный режим завершен. Результаты для самопроверки.';
                } else if (percentage >= 90) {
                    message = 'Отличный результат! Вы продемонстрировали отличные знания.';
                } else if (percentage >= 70) {
                    message = 'Хороший результат! У вас есть solid знания.';
                } else if (percentage >= 50) {
                    message = 'Удовлетворительный результат. Рекомендуется углубить знания по темам, где были допущены ошибки.';
                } else {
                    message = 'Необходимо изучить материал более глубоко.';
                }
                
                if (testState.skippedQuestions.length > 0 && testState.testMode === 'exam') {
                    message += `<br><br><strong>Внимание:</strong> Вы пропустили ${testState.skippedQuestions.length} вопрос(ов). Они были засчитаны как неправильные.`;
                }
                
                message += `<br><br><strong>Время прохождения теста:</strong> ${testTime}`;
                message += `<br><strong>Настройки теста:</strong> ${settingsText}`;
                
                // Добавляем информацию о времени на вопросы
                if (testState.extendedStats.averageTimePerQuestion > 0) {
                    message += `<br><strong>Среднее время на вопрос:</strong> ${testState.extendedStats.averageTimePerQuestion} сек`;
                }
                
                elements.resultMessage.innerHTML = message;
                
                elements.resultPanel.style.display = 'block';
                
                elements.singleQuestionDisplay.innerHTML = '';
                elements.testInfo.style.display = 'none';
                elements.progressContainer.style.display = 'none';
                elements.timerContainer.style.display = 'none';
                elements.jumpToQuestion.style.display = 'none';
                elements.bookmarkedQuestions.style.display = 'none';
                
                this.generateExtendedStats();
                this.generateDetailedResults();
            }
            
            generateExtendedStats() {
                const stats = testState.extendedStats;
                
                elements.statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${stats.totalQuestions}</div>
                        <div class="stat-label">Всего вопросов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.correctCount}</div>
                        <div class="stat-label">Правильных ответов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.incorrectCount}</div>
                        <div class="stat-label">Неправильных ответов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.skippedCount}</div>
                        <div class="stat-label">Пропущено</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.percentage}%</div>
                        <div class"stat-label">Процент правильных</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.averageTimePerQuestion} сек</div>
                        <div class="stat-label">Среднее время на вопрос</div>
                    </div>
                `;
                
                let sectionStatsHTML = '<h4 style="color: #1a3a8f; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-pie"></i> Результаты по разделам:</h4>';
                
                for (const sectionName in testState.sectionStats) {
                    const section = testState.sectionStats[sectionName];
                    const fillWidth = section.percentage > 0 ? section.percentage : 0;
                    
                    sectionStatsHTML += `
                        <div class="section-stat-item">
                            <div class="section-stat-header">
                                <div class="section-stat-name">${sectionName}</div>
                                <div class="section-stat-percentage">${section.percentage}% (${section.correct}/${section.total})</div>
                            </div>
                            <div class="section-stat-bar">
                                <div class="section-stat-fill" style="width: ${fillWidth}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                elements.sectionStats.innerHTML = sectionStatsHTML;
                
                elements.extendedStats.style.display = 'block';
            }
            
            generateDetailedResults() {
                elements.detailedResultsContent.innerHTML = '';
                
                testState.questionResults.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = `result-item-details ${result.status} fade-in`;
                    
                    const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    switch (result.status) {
                        case 'correct':
                            statusText = 'Правильно';
                            statusClass = 'status-correct';
                            break;
                        case 'incorrect':
                            statusText = 'Неправильно';
                            statusClass = 'status-incorrect';
                            break;
                        case 'skipped':
                            statusText = 'Пропущено';
                            statusClass = 'status-skipped';
                            break;
                        case 'unanswered':
                            statusText = 'Не отвечено';
                            statusClass = 'status-incorrect';
                            break;
                    }
                    
                    const optionsHTML = result.options.map((option, index) => {
                        const optionLetter = optionLetters[index];
                        let optionClass = '';
                        
                        if (optionLetter === result.correctAnswer) {
                            optionClass = 'correct';
                        }
                        if (optionLetter === result.userAnswer && result.userAnswer !== result.correctAnswer) {
                            optionClass = 'incorrect';
                        }
                        
                        return `
                            <div class="result-item-answer">
                                <span class="answer-letter ${optionClass}">${optionLetter}</span>
                                <span class="answer-text">${option}</span>
                            </div>
                        `;
                    }).join('');
                    
                    // Отображение времени на вопрос
                    const timeSpentInfo = result.timeSpent > 0 ? 
                        `<div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                            <strong>Время на вопрос:</strong> ${result.timeSpent} сек
                        </div>` : '';
                    
                    resultItem.innerHTML = `
                        <div class="result-item-header">
                            <div class="result-item-number">Вопрос ${result.number} (${result.section})</div>
                            <div class="result-item-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="result-item-question">${result.questionText}</div>
                        <div class="result-item-answers">
                            ${optionsHTML}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            <strong>Ваш ответ:</strong> ${result.userAnswer || 'Нет ответа'} | 
                            <strong>Правильный ответ:</strong> ${result.correctAnswer} |
                            <strong>Сложность:</strong> ${result.difficulty}
                        </div>
                        ${timeSpentInfo}
                        ${result.explanation ? `
                            <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-size: 0.9rem;">
                                <strong>Объяснение:</strong> ${result.explanation}
                            </div>
                        ` : ''}
                    `;
                    
                    elements.detailedResultsContent.appendChild(resultItem);
                });
            }
            
            showDetailedResults() {
                elements.resultPanel.style.display = 'none';
                elements.extendedStats.style.display = 'none';
                elements.detailedResults.style.display = 'block';
                
                // Ключевое исправление: скроллим к верху страницы вместо конца
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Также скроллим к верху контейнера с детальными результатами
                if (elements.detailedResultsContent.firstChild) {
                    elements.detailedResultsContent.firstChild.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }
            }
            
            showReviewSection() {
                if (testState.totalQuestions === 0) {
                    alert('Нет вопросов для просмотра');
                    return;
                }
                
                testState.reviewMode = true;
                testState.currentReviewQuestion = 1;
                
                elements.resultPanel.style.display = 'none';
                elements.detailedResults.style.display = 'none';
                elements.extendedStats.style.display = 'none';
                
                elements.reviewSection.style.display = 'block';
                
                this.showReviewQuestion();
                
                // Скроллим к верху раздела просмотра
                window.scrollTo({ top: 0, behavior: 'smooth' });
                elements.reviewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            showReviewQuestion() {
                const questionNumber = testState.currentReviewQuestion;
                
                const questionData = testState.questions[questionNumber - 1];
                if (!questionData) return;
                
                elements.reviewQuestionCounter.textContent = `Вопрос ${questionNumber} из ${testState.totalQuestions}`;
                
                const questionText = questionData.text;
                const correctAnswer = questionData.correctAnswer;
                const userAnswer = testState.answers[questionNumber];
                const options = questionData.options;
                const isSkipped = testState.skippedQuestions.includes(questionNumber);
                const explanation = questionData.explanation || '';
                
                let sectionName = questionData.section || 'Общие вопросы';
                
                let optionsHTML = '';
                const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                
                options.forEach((option, index) => {
                    const optionValue = optionLetters[index];
                    const optionText = option;
                    const optionLetter = optionLetters[index];
                    
                    let optionClass = '';
                    let isUserSelected = optionValue === userAnswer;
                    let isCorrect = optionValue === correctAnswer;
                    
                    if (isCorrect && isUserSelected) {
                        optionClass = 'correct selected';
                    } else if (isCorrect) {
                        optionClass = 'correct';
                    } else if (isUserSelected && !isCorrect) {
                        optionClass = 'incorrect selected';
                    } else if (isUserSelected) {
                        optionClass = 'selected';
                    }
                    
                    optionsHTML += `
                        <div class="single-option ${optionClass}">
                            <span class="single-option-letter">${optionLetter}</span>
                            <span class="single-option-text">${optionText}</span>
                        </div>
                    `;
                });
                
                let statusText = '';
                let statusColor = '';
                let statusIcon = '';
                
                if (isSkipped) {
                    statusText = 'Вопрос пропущен (засчитан как неправильный)';
                    statusColor = '#ff9800';
                    statusIcon = '⚠️';
                } else if (!userAnswer) {
                    statusText = 'Не отвечено (засчитан как неправильный)';
                    statusColor = '#e74c3c';
                    statusIcon = '✕';
                } else if (userAnswer === correctAnswer) {
                    statusText = 'Правильно';
                    statusColor = '#27ae60';
                    statusIcon = '✓';
                } else {
                    statusText = 'Неправильно';
                    statusColor = '#e74c3c';
                    statusIcon = '✕';
                }
                
                // Время на вопрос в просмотре
                const timeSpent = testState.questionTimers[questionNumber] || 0;
                const timeInfo = timeSpent > 0 ? 
                    `<div style="margin: 10px 0; padding: 8px 12px; background-color: #f8f9fa; border-radius: 5px; font-size: 0.9rem;">
                        <i class="fas fa-clock"></i> Время на вопрос: ${timeSpent} сек
                    </div>` : '';
                
                const reviewHTML = `
                    <div class="single-question-container fade-in" style="display: block;">
                        <div class="question-progress">
                            <div class="question-number-large">${questionNumber}</div>
                            <div class="question-progress-bar">
                                <div class="question-progress-fill" style="width: ${(questionNumber / testState.totalQuestions) * 100}%"></div>
                            </div>
                            <div class="question-progress-text">
                                ${questionNumber} из ${testState.totalQuestions}
                            </div>
                        </div>
                        
                        <div class="section-indicator">
                            ${sectionName}
                        </div>
                        
                        <div style="background-color: ${statusColor}20; border-left: 4px solid ${statusColor}; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${statusIcon}</span>
                            <div>
                                <strong style="color: ${statusColor};">${statusText}</strong><br>
                                <span style="font-size: 0.9rem; color: #666;">
                                    Ваш ответ: <strong>${userAnswer || 'Нет ответа'}</strong> | 
                                    Правильный ответ: <strong>${correctAnswer}</strong>
                                </span>
                            </div>
                        </div>
                        
                        ${timeInfo}
                        
                        <div class="single-question-text">${questionText}</div>
                        
                        <div class="single-options">
                            ${optionsHTML}
                        </div>
                        
                        ${explanation ? `
                            <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <strong><i class="fas fa-lightbulb"></i> Объяснение:</strong><br>
                                ${explanation}
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 10px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 20px; height: 20px; background-color: #eef2ff; border: 2px solid #2d5cc2; border-radius: 4px;"></div>
                                    <span>Ваш выбор</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 20px; height: 20px; background-color: #e7f7ef; border: 2px solid #27ae60; border-radius: 4px;"></div>
                                    <span>Правильный ответ</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 20px; height: 20px; background-color: #fdeaea; border: 2px solid #e74c3c; border-radius: 4px;"></div>
                                    <span>Неправильный ответ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                elements.reviewContent.innerHTML = reviewHTML;
                
                elements.reviewPrev.disabled = (questionNumber === 1);
                elements.reviewNext.disabled = (questionNumber === testState.totalQuestions);
                
                // Скроллим к вопросу в режиме просмотра
                setTimeout(() => {
                    const reviewQuestion = document.querySelector('.single-question-container');
                    if (reviewQuestion) {
                        reviewQuestion.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            }
            
            showResultsPanel() {
                elements.reviewSection.style.display = 'none';
                elements.detailedResults.style.display = 'none';
                elements.extendedStats.style.display = 'block';
                
                elements.resultPanel.style.display = 'block';
                
                // Скроллим к верху панели результатов
                window.scrollTo({ top: 0, behavior: 'smooth' });
                elements.resultPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            resetTest() {
                // Очищаем интервалы
                if (testState.timer) {
                    clearInterval(testState.timer);
                }
                
                if (testState.questionTimer) {
                    clearInterval(testState.questionTimer);
                }
                
                // Очищаем таймер автоматического перехода
                if (testState.autoTransitionTimer) {
                    clearTimeout(testState.autoTransitionTimer);
                    testState.autoTransitionTimer = null;
                }
                
                // Сбрасываем состояние
                testState = {
                    userName: '',
                    userPosition: '',
                    userDepartment: '',
                    timeLimit: DEFAULT_TIME_LIMIT,
                    timeLeft: DEFAULT_TIME_LIMIT,
                    timer: null,
                    currentQuestion: 1,
                    answers: {},
                    answeredLocked: {}, // Сбрасываем блокировку ответов
                    reviewMode: false,
                    currentReviewQuestion: 1,
                    skippedQuestions: [],
                    bookmarkedQuestions: [],
                    skippedQuestionsMode: false,
                    currentSkippedIndex: 0,
                    skippedQuestionsList: [],
                    startTime: null,
                    endTime: null,
                    testTitle: testState.testTitle,
                    sections: testState.sections,
                    questions: testState.questions,
                    originalQuestions: testState.originalQuestions,
                    questionResults: [],
                    sectionStats: {},
                    extendedStats: {},
                    isPaused: false,
                    isOnline: navigator.onLine,
                    totalQuestions: testState.questions ? testState.questions.length : 0,
                    testId: null,
                    // Сбрасываем аналитику времени
                    questionTimers: {},
                    questionStartTime: null,
                    // Таймер для отслеживания времени на текущий вопрос
                    questionTimer: null,
                    currentQuestionTime: 0,
                    // Настройки теста
                    shuffleQuestions: false,
                    testSettings: {
                        timeLimit: 60,
                        shuffleEnabled: false
                    },
                    // Добавляем флаг для показа результата
                    showAnswerFeedback: true,
                    // Добавляем таймер для автоматического перехода
                    autoTransitionTimer: null,
                    // Сбрасываем режим тестирования
                    testMode: 'exam',
                    // Сбрасываем историю тренировочного режима
                    trainingHistory: {}
                };
                
                // Скрываем все элементы
                elements.resultPanel.style.display = 'none';
                elements.reviewSection.style.display = 'none';
                elements.detailedResults.style.display = 'none';
                elements.extendedStats.style.display = 'none';
                elements.userInfoForm.style.display = 'block';
                elements.testSettingsForm.style.display = 'none';
                elements.jsonUploadContainer.style.display = 'none';
                elements.passwordModal.style.display = 'none';
                elements.singleQuestionDisplay.innerHTML = '';
                elements.jumpToQuestion.style.display = 'none';
                elements.bookmarkedQuestions.style.display = 'none';
                elements.allQuestionsContainer.innerHTML = '';
                
                // Сбрасываем таймер и прогресс
                elements.timer.textContent = '60:00';
                elements.timer.classList.remove('warning', 'danger');
                elements.progressBar.style.width = '0%';
                
                // Сбрасываем настройки к значениям по умолчанию
                elements.timeLimitSlider.value = 60;
                elements.timeLimitInput.value = 60;
                elements.shuffleQuestionsCheckbox.checked = false;
                this.updateTimeDisplay(60);
                
                // Очищаем форму
                document.getElementById('user-name').value = '';
                document.getElementById('user-position').value = '';
                document.getElementById('user-department').value = '';
                elements.startPasswordInput.value = '';
                
                // Сбрасываем выбор режима тестирования
                document.querySelector('input[name="test-mode"][value="exam"]').checked = true;
                
                document.querySelector('#user-info-form h3').innerHTML = `<i class="fas fa-user"></i> ${testState.testTitle}`;
            }
            
            showExportProgress() {
                elements.exportProgress.style.display = 'flex';
                elements.exportProgressFill.style.width = '0%';
                elements.exportStatus.textContent = 'Подготовка данных...';
                elements.exportMessage.textContent = 'Пожалуйста, подождите...';
            }
            
            hideExportProgress() {
                elements.exportProgress.style.display = 'none';
            }
            
            updateExportProgress(progress, status, message) {
                elements.exportProgressFill.style.width = `${progress}%`;
                elements.exportStatus.textContent = status;
                if (message) {
                    elements.exportMessage.textContent = message;
                }
            }
            
            exportToWordOffline() {
                this.showExportProgress();
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    this.updateExportProgress(progress, 'Создание документа Word (офлайн)...');
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            this.generateWordDocumentOffline();
                            this.hideExportProgress();
                        }, 500);
                    }
                }, 100);
            }
            
            generateWordDocumentOffline() {
                try {
                    const results = this.checkAnswers();
                    const percentage = testState.totalQuestions > 0 ? Math.round((results.correctCount / testState.totalQuestions) * 100) : 0;
                    const testTime = this.calculateTestTime();
                    
                    const sectionResults = testState.sectionStats;
                    
                    // Проверяем наличие библиотеки html-docx-js
                    if (typeof htmlDocx === 'undefined') {
                        throw new Error('Библиотека html-docx-js не загружена. Проверьте подключение к интернету или добавьте библиотеку локально.');
                    }
                    
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>Результаты теста - ${testState.testTitle}</title>
                            <style>
                                body {
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                    color: #333;
                                    line-height: 1.6;
                                    margin: 0;
                                    padding: 20px;
                                }
                                .header {
                                    background: linear-gradient(135deg, #1a3a8f 0%, #2d5cc2 100%);
                                    color: white;
                                    padding: 30px 0;
                                    text-align: center;
                                    margin-bottom: 30px;
                                    border-radius: 10px;
                                }
                                .header h1 {
                                    font-size: 28px;
                                    margin-bottom: 15px;
                                    color: white;
                                }
                                .header h2 {
                                    font-size: 20px;
                                    margin-bottom: 30px;
                                    color: white;
                                    opacity: 0.9;
                                }
                                .user-info {
                                    font-size: 14px;
                                    margin-top: 30px;
                                    background: rgba(255, 255, 255, 0.2);
                                    padding: 15px;
                                    border-radius: 10px;
                                    display: inline-block;
                                    text-align: left;
                                    line-height: 1.6;
                                }
                                .user-info strong {
                                    display: block;
                                    margin-bottom: 8px;
                                    font-size: 16px;
                                }
                                .section {
                                    margin-bottom: 30px;
                                }
                                .section-title {
                                    color: #1a3a8f;
                                    border-bottom: 2px solid #eef2ff;
                                    padding-bottom: 8px;
                                    margin-bottom: 15px;
                                    font-size: 18px;
                                    font-weight: bold;
                                }
                                .summary-table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 15px 0;
                                }
                                .summary-table th {
                                    background-color: #eef2ff;
                                    color: #1a3a8f;
                                    padding: 12px;
                                    text-align: left;
                                    font-weight: bold;
                                    border: 1px solid #ccc;
                                }
                                .summary-table td {
                                    padding: 12px;
                                    border-bottom: 1px solid #e6e9f0;
                                    border: 1px solid #ccc;
                                }
                                .summary-table .highlight {
                                    background-color: #f8f9fa;
                                    font-weight: bold;
                                }
                                .results-box {
                                    display: flex;
                                    justify-content: space-around;
                                    margin: 20px 0;
                                    flex-wrap: wrap;
                                }
                                .result-item {
                                    text-align: center;
                                    padding: 15px;
                                    border-radius: 8px;
                                    background-color: #f8f9fa;
                                    min-width: 120px;
                                    margin: 8px;
                                    border: 1px solid #ddd;
                                }
                                .result-value {
                                    font-size: 22px;
                                    font-weight: bold;
                                    margin-bottom: 8px;
                                }
                                .result-value.correct {
                                    color: #27ae60;
                                }
                                .result-value.incorrect {
                                    color: #e74c3c;
                                }
                                .score-circle {
                                    width: 180px;
                                    height: 180px;
                                    border-radius: 50%;
                                    background: conic-gradient(#27ae60 0% ${percentage}%, #e6e9f0 ${percentage}% 100%);
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                    margin: 15px auto;
                                    position: relative;
                                }
                                .score-circle::before {
                                    content: '';
                                    position: absolute;
                                    width: 140px;
                                    height: 140px;
                                    background-color: white;
                                    border-radius: 50%;
                                }
                                .score-value {
                                    font-size: 32px;
                                    font-weight: bold;
                                    color: #1a3a8f;
                                    z-index: 1;
                                }
                                .score-label {
                                    font-size: 14px;
                                    color: #666;
                                    z-index: 1;
                                }
                                .question-block {
                                    margin-bottom: 20px;
                                    padding: 15px;
                                    border: 1px solid #e6e9f0;
                                    border-radius: 8px;
                                }
                                .question-number {
                                    font-size: 16px;
                                    font-weight: bold;
                                    color: #1a3a8f;
                                    margin-bottom: 8px;
                                }
                                .question-text {
                                    font-size: 14px;
                                    margin-bottom: 12px;
                                    font-weight: 600;
                                }
                                .option {
                                    padding: 6px 0;
                                    margin-left: 15px;
                                }
                                .option.correct {
                                    color: #27ae60;
                                    font-weight: bold;
                                }
                                .option.incorrect {
                                    color: #e74c3c;
                                }
                                .option.selected {
                                    background-color: #eef2ff;
                                    padding: 6px;
                                    border-radius: 5px;
                                }
                                .status {
                                    margin-top: 8px;
                                    padding: 6px;
                                    border-radius: 5px;
                                    font-weight: bold;
                                }
                                .status-correct {
                                    background-color: #e7f7ef;
                                    color: #27ae60;
                                    border: 1px solid #27ae60;
                                }
                                .status-incorrect {
                                    background-color: #fdeaea;
                                    color: #e74c3c;
                                    border: 1px solid #e74c3c;
                                }
                                .status-skipped {
                                    background-color: #fff3cd;
                                    color: #ff9800;
                                    border: 1px solid #ff9800;
                                }
                                .footer {
                                    text-align: center;
                                    color: #666;
                                    font-size: 12px;
                                    margin-top: 40px;
                                    border-top: 1px solid #e6e9f0;
                                    padding-top: 15px;
                                }
                                .security-note {
                                    background-color: #f8f9ff;
                                    border: 1px solid #2d5cc2;
                                    border-radius: 8px;
                                    padding: 12px;
                                    margin: 15px 0;
                                    font-size: 14px;
                                    color: #1a3a8f;
                                }
                                .test-settings-info {
                                    background-color: #f0f4ff;
                                    padding: 12px;
                                    border-radius: 8px;
                                    margin: 12px 0;
                                    border-left: 4px solid #2d5cc2;
                                }
                                .time-info {
                                    font-size: 13px;
                                    color: #666;
                                    margin-top: 5px;
                                }
                                .training-mode-indicator {
                                    background-color: #3498db;
                                    color: white;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    font-weight: bold;
                                    display: inline-block;
                                    margin-bottom: 15px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ</h1>
                                <h2>${testState.testTitle}</h2>
                                ${testState.testMode === 'training' ? 
                                    '<div class="training-mode-indicator">ТРЕНАЖЕРНЫЙ РЕЖИМ (результаты для самопроверки)</div>' : ''}
                                <div class="score-circle">
                                    <div class="score-value">${percentage}%</div>
                                    <div class="score-label">правильных ответов</div>
                                </div>
                                <div class="user-info">
                                    <strong>ДАННЫЕ ПОЛЬЗОВАТЕЛЯ</strong>
                                    ФИО: ${testState.userName || 'Не указано'}<br>
                                    Должность: ${testState.userPosition || 'Не указана'}<br>
                                    Подразделение: ${testState.userDepartment || 'Не указано'}<br>
                                    Дата тестирования: ${new Date().toLocaleDateString('ru-RU')}<br>
                                    Время тестирования: ${new Date().toLocaleTimeString('ru-RU')}<br>
                                    Время прохождения: ${testTime}
                                </div>
                            </div>
                            
                            <div class="test-settings-info">
                                <strong><i class="fas fa-cogs"></i> Настройки теста:</strong><br>
                                Временной лимит: ${testState.testSettings.timeLimit} минут<br>
                                Порядок вопросов: ${testState.testSettings.shuffleEnabled ? 'Случайный' : 'Стандартный'}<br>
                                Режим тестирования: ${testState.testMode === 'training' ? 'Тренировочный' : 'Экзаменационный'}
                            </div>
                            
                            <div class="security-note">
                                <strong><i class="fas fa-key"></i> Защищенный тест:</strong> 
                                Вопросы в системе тестирования были защищены шифрованием.
                            </div>
                            
                            <div class="section">
                                <div class="section-title">Общие результаты тестирования</div>
                                
                                <div style="margin: 15px 0; padding: 12px; background-color: #f8f9fa; border-radius: 8px;">
                                    <strong>Статистика:</strong><br>
                                    Всего вопросов: ${testState.totalQuestions}<br>
                                    Правильных ответов: ${results.correctCount}<br>
                                    Неправильных ответов: ${results.answeredCount - results.correctCount}<br>
                                    Пропущено вопросов: ${testState.skippedQuestions.length}<br>
                                    Всего отвечено: ${results.answeredCount}/${testState.totalQuestions}<br>
                                    Процент правильных ответов: ${percentage}%<br>
                                    Среднее время на вопрос: ${testState.extendedStats.averageTimePerQuestion} сек
                                </div>
                                
                                ${testState.skippedQuestions.length > 0 ? `
                                    <div style="margin: 15px 0; padding: 12px; background-color: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                        <strong>Внимание:</strong> 
                                        Вы пропустили ${testState.skippedQuestions.length} вопрос(ов). Они были засчитаны как неправильные.
                                    </div>
                                ` : ''}
                                
                                <table class="summary-table">
                                    <tr>
                                        <th>Раздел</th>
                                        <th>Всего вопросов</th>
                                        <th>Правильно</th>
                                        <th>Процент</th>
                                    </tr>
                                    ${Object.keys(sectionResults).map(sectionName => {
                                        const section = sectionResults[sectionName];
                                        return `
                                            <tr>
                                                <td>${sectionName}</td>
                                                <td>${section.total}</td>
                                                <td>${section.correct}</td>
                                                <td>${section.percentage}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr class="highlight">
                                        <td><strong>Итого</strong></td>
                                        <td><strong>${testState.totalQuestions}</strong></td>
                                        <td><strong>${results.correctCount}</strong></td>
                                        <td><strong>${percentage}%</strong></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <div class="section-title">Детальные результаты по вопросам</div>
                                
                                ${Array.from({length: testState.totalQuestions}, (_, i) => i + 1).map(i => {
                                    const questionData = testState.questions[i - 1];
                                    if (!questionData) return '';
                                    
                                    const questionText = questionData.text;
                                    const correctAnswer = questionData.correctAnswer;
                                    const userAnswer = testState.answers[i];
                                    const isSkipped = testState.skippedQuestions.includes(i);
                                    const options = questionData.options;
                                    const sectionName = questionData.section || 'Общие вопросы';
                                    const explanation = questionData.explanation || '';
                                    const timeSpent = testState.questionTimers[i] || 0;
                                    
                                    const optionLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                                    
                                    let status = '';
                                    let statusClass = '';
                                    
                                    if (isSkipped) {
                                        status = 'Пропущен (засчитан как неправильный)';
                                        statusClass = 'status-skipped';
                                    } else if (!userAnswer) {
                                        status = 'Не отвечен';
                                        statusClass = 'status-incorrect';
                                    } else if (userAnswer === correctAnswer) {
                                        status = 'Правильно';
                                        statusClass = 'status-correct';
                                    } else {
                                        status = 'Неправильно';
                                        statusClass = 'status-incorrect';
                                    }
                                    
                                    let optionsHTML = '';
                                    options.forEach((option, index) => {
                                        const optionValue = optionLetters[index];
                                        const optionText = option;
                                        
                                        let optionClass = '';
                                        if (optionValue === correctAnswer) {
                                            optionClass = 'correct';
                                        } else if (optionValue === userAnswer && userAnswer !== correctAnswer) {
                                            optionClass = 'incorrect';
                                        } else if (optionValue === userAnswer) {
                                            optionClass = 'selected';
                                        }
                                        
                                        optionsHTML += `
                                            <div class="option ${optionClass}">
                                                ${optionValue}. ${optionText}
                                            </div>
                                        `;
                                    });
                                    
                                    const timeInfo = timeSpent > 0 ? 
                                        `<div class="time-info">
                                            <strong>Время на вопрос:</strong> ${timeSpent} сек
                                        </div>` : '';
                                    
                                    return `
                                        <div class="question-block">
                                            <div class="question-number">Вопрос ${i} (${sectionName})</div>
                                            <div class="question-text">${questionText}</div>
                                            <div>
                                                ${optionsHTML}
                                            </div>
                                            <div class="status ${statusClass}">
                                                ${status}. Ваш ответ: ${userAnswer || 'Нет ответа'}. Правильный ответ: ${correctAnswer}
                                            </div>
                                            ${timeInfo}
                                            ${explanation ? `
                                                <div style="margin-top: 8px; padding: 8px; background-color: #f8f9fa; border-radius: 5px; font-size: 13px;">
                                                    <strong>Объяснение:</strong> ${explanation}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div class="footer">
                                <p>${testState.testTitle} &copy; 2026</p>
                                <p>Документ сгенерирован автоматически в офлайн-режиме</p>
                                <p><strong>Данные пользователя:</strong> ФИО: ${testState.userName || 'Не указано'} | Должность: ${testState.userPosition || 'Не указана'} | Подразделение: ${testState.userDepartment || 'Не указано'}</p>
                                <p>Вопросы были защищены с использованием шифрования</p>
                                ${testState.testMode === 'training' ? '<p><strong>Тренировочный режим:</strong> Результаты для самопроверки</p>' : ''}
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Используем html-docx-js для преобразования HTML в документ Word
                    const converted = htmlDocx.asBlob(htmlContent, {
                        orientation: 'portrait',
                        margins: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                    });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(converted);
                    link.download = `Результаты_${testState.testTitle.replace(/["']/g, '').replace(/\s+/g, '_')}_${(testState.userName || 'Пользователь').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.docx`;
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    document.body.removeChild(link);
                    
                } catch (error) {
                    console.error('Ошибка при экспорте в Word:', error);
                    alert('Произошла ошибка при экспорте в Word: ' + error.message);
                    this.hideExportProgress();
                }
            }
            
            exportToExcelXLSX() {
                this.showExportProgress();
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    this.updateExportProgress(progress, 'Создание документа Excel...');
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            this.generateExcelXLSXDocument();
                            this.hideExportProgress();
                        }, 500);
                    }
                }, 100);
            }
            
            generateExcelXLSXDocument() {
                const results = this.checkAnswers();
                const percentage = testState.totalQuestions > 0 ? Math.round((results.correctCount / testState.totalQuestions) * 100) : 0;
                const testTime = this.calculateTestTime();
                
                const workbook = XLSX.utils.book_new();
                
                // Лист с итогами
                const summaryData = [];
                summaryData.push([`РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ - ${testState.testTitle}`]);
                summaryData.push([]);
                summaryData.push(['ДАННЫЕ ПОЛЬЗОВАТЕЛЯ']);
                summaryData.push(['ФИО:', testState.userName || 'Не указано']);
                summaryData.push(['Должность:', testState.userPosition || 'Не указана']);
                summaryData.push(['Подразделение:', testState.userDepartment || 'Не указано']);
                summaryData.push(['Дата прохождения:', new Date().toLocaleDateString('ru-RU')]);
                summaryData.push(['Время прохождения:', new Date().toLocaleTimeString('ru-RU')]);
                summaryData.push(['Время выполнения теста:', testTime]);
                summaryData.push(['Настройки теста:']);
                summaryData.push(['Временной лимит:', `${testState.testSettings.timeLimit} минут`]);
                summaryData.push(['Порядок вопросов:', testState.testSettings.shuffleEnabled ? 'Случайный' : 'Стандартный']);
                summaryData.push(['Режим тестирования:', testState.testMode === 'training' ? 'Тренировочный' : 'Экзаменационный']);
                summaryData.push(['Формат вопросов:', 'Универсальная обработка с шифрованием']);
                summaryData.push([]);
                summaryData.push(['ОБЩИЕ РЕЗУЛЬТАТЫ']);
                summaryData.push(['Правильных ответов:', results.correctCount]);
                summaryData.push(['Неправильных ответов:', results.answeredCount - results.correctCount]);
                summaryData.push(['Пропущено вопросов:', testState.skippedQuestions.length]);
                summaryData.push(['Всего отвечено:', `${results.answeredCount}/${testState.totalQuestions}`]);
                summaryData.push(['Процент правильных ответов:', `${percentage}%`]);
                summaryData.push(['Среднее время на вопрос:', `${testState.extendedStats.averageTimePerQuestion} сек`]);
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Лист с детальными результатами
                const detailedData = [];
                detailedData.push(['ДЕТАЛЬНЫЕ РЕЗУЛЬТАТЫ ПО ВОПРОСАМ']);
                detailedData.push([]);
                detailedData.push(['№', 'Раздел', 'Сложность', 'Вопрос', 'Ваш ответ', 'Правильный ответ', 'Результат', 'Статус', 'Время (сек)']);
                
                for (let i = 1; i <= testState.totalQuestions; i++) {
                    const questionData = testState.questions[i - 1];
                    if (!questionData) continue;
                    
                    const questionText = questionData.text;
                    const correctAnswer = questionData.correctAnswer;
                    const userAnswer = testState.answers[i];
                    const isSkipped = testState.skippedQuestions.includes(i);
                    const sectionName = questionData.section || 'Общие вопросы';
                    const difficulty = questionData.difficulty || 'Средний';
                    const timeSpent = testState.questionTimers[i] || 0;
                    
                    let result = '';
                    let status = '';
                    
                    if (isSkipped) {
                        result = 'Пропущен';
                        status = 'Неправильно';
                    } else if (!userAnswer) {
                        result = 'Не отвечен';
                        status = 'Неправильно';
                    } else if (userAnswer === correctAnswer) {
                        result = 'Правильно';
                        status = 'Правильно';
                    } else {
                        result = 'Неправильно';
                        status = 'Неправильно';
                    }
                    
                    detailedData.push([
                        i,
                        sectionName,
                        difficulty,
                        questionText,
                        userAnswer || 'Нет ответа',
                        correctAnswer,
                        result,
                        status,
                        timeSpent
                    ]);
                }
                
                const detailedSheet = XLSX.utils.aoa_to_sheet(detailedData);
                
                // Лист со статистикой по разделам
                const statsData = [];
                statsData.push(['СТАТИСТИКА ПО РАЗДЕЛАМ']);
                statsData.push(['Анализ результатов по разделам теста']);
                statsData.push([]);
                statsData.push(['Раздел', 'Всего', 'Правильно', 'Неправильно', 'Пропущено', 'Процент', 'Уровень знаний']);
                
                const getGrade = (percentage) => {
                    if (percentage >= 90) return 'Отличный';
                    if (percentage >= 70) return 'Хороший';
                    if (percentage >= 50) return 'Удовлетворительный';
                    return 'Неудовлетворительный';
                };
                
                for (const sectionName in testState.sectionStats) {
                    const section = testState.sectionStats[sectionName];
                    
                    statsData.push([
                        sectionName,
                        section.total,
                        section.correct,
                        section.incorrect,
                        section.skipped,
                        section.percentage / 100,
                        getGrade(section.percentage)
                    ]);
                }
                
                statsData.push([
                    'Итого',
                    testState.totalQuestions,
                    results.correctCount,
                    results.answeredCount - results.correctCount,
                    testState.skippedQuestions.length,
                    percentage / 100,
                    getGrade(percentage)
                ]);
                
                const statsSheet = XLSX.utils.aoa_to_sheet(statsData);
                
                // Добавляем листы в книгу
                XLSX.utils.book_append_sheet(workbook, summarySheet, "Итоги");
                XLSX.utils.book_append_sheet(workbook, detailedSheet, "Детальные результаты");
                XLSX.utils.book_append_sheet(workbook, statsSheet, "Статистика по разделам");
                
                // Генерируем и скачиваем файл
                const fileName = `Результаты_${testState.testTitle.replace(/["']/g, '').replace(/\s+/g, '_')}_${(testState.userName || 'Пользователь').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(workbook, fileName);
            }
        }
        
        // Инициализация системы при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            window.testSystem = new TestSystem();
            window.testSystem.loadTestCatalog();
            const adminBtn = document.getElementById('go-admin-btn');
            if (adminBtn) {
                adminBtn.addEventListener('click', () => { window.location.href = 'admin.html'; });
            }
        });
    </script>
</body>
</html>